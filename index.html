<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”Ÿè©ç‰¹è¨“ç­ - å­¸è¯èªå‘å‰èµ° ç¬¬äºŒå†Š</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* å¼·åˆ¶è¨­å®šé«˜åº¦ï¼Œé¿å…å®¹å™¨å¡Œé™·å°è‡´çœ‹ä¸åˆ°å­— */
        html, body, #root {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* è‡ªå®šç¾©å‹•ç•«æ¨£å¼ */
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          75% { transform: translateX(5px); }
        }
        .animate-shake {
          animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes fade-in-up {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
          animation: fade-in-up 0.4s ease-out forwards;
        }
        /* æ–°å¢ï¼šèƒŒæ™¯å­—æµ®ç¾å‹•ç•« - ä¿®æ­£ç‰ˆï¼šåŠ å…¥ CSS è®Šæ•¸æ”¯æ´æ—‹è½‰ */
        @keyframes pop-in {
          0% { opacity: 0; transform: translate(-50%, -50%) rotate(var(--rot)) scale(0.5); }
          50% { transform: translate(-50%, -50%) rotate(var(--rot)) scale(1.2); }
          100% { opacity: 0.2; transform: translate(-50%, -50%) rotate(var(--rot)) scale(1); }
        }
        .animate-pop-in {
            animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        /* æ–°å¢ï¼šå—å‚·ç´…å±é–ƒçˆ */
        @keyframes damage-flash {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        .animate-damage {
            animation: damage-flash 0.3s ease-in-out;
        }

        /* ç¦æ­¢é¸å–æ–‡å­—ï¼Œé¿å…éŠæˆ²ä¸­èª¤è§¸ */
        body {
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior: none;
        }
    </style>
</head>
<body class="bg-sky-900 text-white font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- éŸ³æ•ˆç®¡ç†å–®ä¾‹ (å„ªåŒ–æ•ˆèƒ½) ---
        const audioCtxRef = { current: null };
        const initAudio = () => {
            if (!audioCtxRef.current) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    audioCtxRef.current = new AudioContext();
                }
            }
            // å˜—è©¦è§£é– iOS/Chrome çš„éŸ³é »ä¸Šä¸‹æ–‡
            if (audioCtxRef.current && audioCtxRef.current.state === 'suspended') {
                audioCtxRef.current.resume();
            }
        };

        const playSound = (type) => {
            if (!audioCtxRef.current) initAudio();
            const ctx = audioCtxRef.current;
            if (!ctx) return;

            const osc = ctx.createOscillator();
            const gain = ctx.createGain();

            osc.connect(gain);
            gain.connect(ctx.destination);

            const now = ctx.currentTime;

            if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'heal') { // æ–°å¢ï¼šè£œè¡€éŸ³æ•ˆ
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(600, now + 0.1);
                osc.frequency.linearRampToValueAtTime(800, now + 0.2);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(now);
                osc.stop(now + 0.4);
            } else if (type === 'victory') {
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const vOsc = ctx.createOscillator();
                    const vGain = ctx.createGain();
                    vOsc.type = 'triangle';
                    vOsc.frequency.setValueAtTime(freq, now + i * 0.15);
                    vGain.gain.setValueAtTime(0.2, now + i * 0.15);
                    vGain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.15 + 0.8);
                    vOsc.connect(vGain);
                    vGain.connect(ctx.destination);
                    vOsc.start(now + i * 0.15);
                    vOsc.stop(now + i * 0.15 + 0.8);
                });
            }
        };

        // --- å…§å»ºåœ–æ¨™çµ„ä»¶ ---
        const Icon = ({ children, size = 24, className = "", ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const Play = (props) => <Icon {...props}><polygon points="5 3 19 12 5 21 5 3" /></Icon>;
        const Pause = (props) => <Icon {...props}><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></Icon>;
        const PlayCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><polygon points="10 8 16 12 10 16 10 8" /></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></Icon>;
        const Heart = (props) => <Icon {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /></Icon>;
        const Star = (props) => <Icon {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></Icon>;
        const Target = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><circle cx="12" cy="12" r="6" /><circle cx="12" cy="12" r="2" /></Icon>;
        const Volume2 = (props) => <Icon {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /></Icon>;
        const Grid = (props) => <Icon {...props}><rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="14" y="14" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /></Icon>;
        const Trophy = (props) => <Icon {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M10 14.66V17" /><path d="M14 14.66V17" /><path d="M12 17v5" /><path d="m18 2-3.4 9h-5.2L6 2Z" /></Icon>;
        const Home = (props) => <Icon {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></Icon>;
        const ArrowLeft = (props) => <Icon {...props}><line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" /></Icon>;
        const Edit3 = (props) => <Icon {...props}><path d="M12 20h9" /><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z" /></Icon>;
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></Icon>;
        const FastForward = (props) => <Icon {...props}><polygon points="13 19 22 12 13 5 13 19" /><polygon points="2 19 11 12 2 5 2 19" /></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></Icon>;
        const AlertCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></Icon>;
        const Zap = (props) => <Icon {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></Icon>;
        const Gift = (props) => <Icon {...props}><polyline points="20 12 20 22 4 22 4 12" /><rect x="2" y="7" width="20" height="5" /><line x1="12" y1="22" x2="12" y2="7" /><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" /><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" /></Icon>;
        const Share2 = (props) => <Icon {...props}><circle cx="18" cy="5" r="3" /><circle cx="6" cy="12" r="3" /><circle cx="18" cy="19" r="3" /><line x1="8.59" y1="13.51" x2="15.42" y2="17.49" /><line x1="15.41" y1="6.51" x2="8.59" y2="10.49" /></Icon>;
        const Copy = (props) => <Icon {...props}><rect x="9" y="9" width="13" height="13" rx="2" ry="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></Icon>;
        const User = (props) => <Icon {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></Icon>;

        // --- æ–°å¢çµ„ä»¶ï¼šåŠ‡æƒ…é€²åº¦æ¢ ---
        const StoryProgressBar = ({ current, total, character, startIcon, endIcon }) => {
            const percentage = Math.min(100, Math.max(0, (current / total) * 100));
            
            return (
                <div className="w-48 md:w-64 h-10 relative mt-2 select-none" title={`é€²åº¦: ${current}/${total}`}>
                    <div className="absolute top-1/2 left-0 right-0 h-3 bg-sky-800/60 rounded-full -translate-y-1/2 border border-sky-600/30 overflow-hidden">
                        <div 
                            className="h-full bg-gradient-to-r from-green-500 to-emerald-400 transition-all duration-500 ease-out"
                            style={{ width: `${percentage}%` }}
                        ></div>
                    </div>
                    <div className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1/4 z-0 opacity-80">
                        <div className="text-lg">{startIcon}</div>
                    </div>
                    <div className="absolute right-0 top-1/2 -translate-y-1/2 translate-x-1/4 z-10 animate-pulse">
                        <div className="text-xl drop-shadow-md">{endIcon}</div>
                    </div>
                    <div 
                        className="absolute top-1/2 -translate-y-1/2 z-20 transition-all duration-500 ease-out"
                        style={{ left: `${percentage}%`, transform: `translate(-50%, -50%)` }}
                    >
                        <div className="relative">
                            <div className="text-3xl filter drop-shadow-lg transform -scale-x-100">{character}</div>
                            <div className="absolute top-3/4 right-full -translate-y-1/2 flex gap-0.5">
                                <div className="w-1.5 h-1.5 bg-white/50 rounded-full animate-ping opacity-75"></div>
                                <div className="w-1 h-1 bg-white/30 rounded-full animate-ping delay-75 opacity-75"></div>
                            </div>
                            <div className="absolute -top-6 left-1/2 -translate-x-1/2 bg-black/60 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold whitespace-nowrap backdrop-blur-sm border border-white/20">
                                {current}/{total}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- é è¨­éŠæˆ²è³‡æ–™ï¼šåˆ†èª²ç”Ÿè©åº« ---
        const DEFAULT_LESSON_DATA = {
          1: {
            title: "ç¬¬ä¸€èª²ï¼šæ–°åŒå­¸",
            words: [
              { id: "1-1", chinese: "æ¯”è¼ƒ", pinyin: "bÇ jiÃ o", zhuin: "ã„…ã„§Ë‡ ã„ã„§ã„ Ë‹" },
              { id: "1-2", chinese: "å¤§å®¶", pinyin: "dÃ  jiÄ", zhuin: "ã„‰ã„šË‹ ã„ã„§ã„š" },
              { id: "1-3", chinese: "æ–¹å‹æœ‹", pinyin: "FÄng YÇ’u pÃ©ng", zhuin: "ã„ˆã„¤ ã„§ã„¡Ë‡ ã„†ã„¥ËŠ" },
              { id: "1-4", chinese: "é«˜èˆˆ", pinyin: "gÄo xÃ¬ng", zhuin: "ã„ã„  ã„’ã„§ã„¥Ë‹" },
              { id: "1-5", chinese: "è·Ÿ", pinyin: "gÄ“n", zhuin: "ã„ã„£" },
              { id: "1-6", chinese: "æ­¡è¿", pinyin: "huÄn yÃ­ng", zhuin: "ã„ã„¨ã„¢ ã„§ã„¥ËŠ" },
              { id: "1-7", chinese: "ä»Šå¹´", pinyin: "jÄ«n niÃ¡n", zhuin: "ã„ã„§ã„£ ã„‹ã„§ã„¢ËŠ" },
              { id: "1-8", chinese: "ä»‹ç´¹", pinyin: "jiÃ¨ shÃ o", zhuin: "ã„ã„§ã„Ë‹ ã„•ã„ Ë‹" },
              { id: "1-9", chinese: "è‡ªå·±", pinyin: "zÃ¬ jÇ", zhuin: "ã„—Ë‹ ã„ã„§Ë‡" },
              { id: "1-10", chinese: "çœ‹æ›¸", pinyin: "kÃ n shÅ«", zhuin: "ã„ã„¢Ë‹ ã„•ã„¨" },
              { id: "1-11", chinese: "èªè­˜", pinyin: "rÃ¨n shÃ¬", zhuin: "ã„–ã„£Ë‹ ã„•Ë‹" },
              { id: "1-12", chinese: "ç¾åœ¨", pinyin: "xiÃ n zÃ i", zhuin: "ã„’ã„§ã„¢Ë‹ ã„—ã„Ë‹" },
              { id: "1-13", chinese: "æ–°", pinyin: "xÄ«n", zhuin: "ã„’ã„§ã„£" },
              { id: "1-14", chinese: "å­¸", pinyin: "xuÃ©", zhuin: "ã„’ã„©ã„ËŠ" },
              { id: "1-15", chinese: "æ¸¸æ³³", pinyin: "ã„§ã„¡ËŠ ã„©ã„¥Ë‡" },
              { id: "1-16", chinese: "æœ€", pinyin: "zuÃ¬", zhuin: "ã„—ã„¨ã„ŸË‹" },
              { id: "1-17", chinese: "è¯èª", pinyin: "huÃ¡ yÇ”", zhuin: "ã„ã„¨ã„šËŠ ã„©Ë‡" },
              { id: "1-18", chinese: "å¼µè‰", pinyin: "ZhÄng LÃ¬", zhuin: "ã„“ã„¤ ã„Œã„§Ë‹" },
            ]
          },
          2: {
            title: "ç¬¬äºŒèª²ï¼šæˆ‘çˆ¸çˆ¸åšç”Ÿæ„",
            words: [
              { id: "2-1", chinese: "å¹«", pinyin: "bÄng", zhuin: "ã„…ã„¤" },
              { id: "2-2", chinese: "é›»è…¦å…¬å¸", pinyin: "diÃ n nÇo gÅng sÄ«", zhuin: "ã„‰ã„§ã„¢Ë‹ ã„‹ã„ Ë‡ ã„ã„¨ã„¥ ã„™" },
              { id: "2-3", chinese: "å·¥ä½œ", pinyin: "gÅng zuÃ²", zhuin: "ã„ã„¨ã„¥ ã„—ã„¨ã„›Ë‹" },
              { id: "2-4", chinese: "ä¸Šç­", pinyin: "shÃ ng bÄn", zhuin: "ã„•ã„¤Ë‹ ã„…ã„¢" },
              { id: "2-5", chinese: "å¤–å…¬", pinyin: "wÃ i gÅng", zhuin: "ã„¨ã„Ë‹ ã„ã„¨ã„¥" },
              { id: "2-6", chinese: "å¤–å©†", pinyin: "wÃ i pÃ³", zhuin: "ã„¨ã„Ë‹ ã„†ã„›ËŠ" },
              { id: "2-7", chinese: "ä¸€æ¨£", pinyin: "yÃ­ yÃ ng", zhuin: "ã„§ËŠ ã„§ã„¤Ë‹" },
              { id: "2-8", chinese: "ä»¥å‰", pinyin: "yÇ qiÃ¡n", zhuin: "ã„§Ë‡ ã„‘ã„§ã„¢ËŠ" },
              { id: "2-9", chinese: "ä»¥å¾Œ", pinyin: "yÇ hÃ²u", zhuin: "ã„§Ë‡ ã„ã„¡Ë‹" },
              { id: "2-10", chinese: "éŠ€è¡Œ", pinyin: "yÃ­n hÃ¡ng", zhuin: "ã„§ã„£ËŠ ã„ã„¤ËŠ" },
              { id: "2-11", chinese: "é†«ç”Ÿ", pinyin: "yÄ« shÄ“ng", zhuin: "ã„§ ã„•ã„¥" },
              { id: "2-12", chinese: "åšç”Ÿæ„", pinyin: "zuÃ² shÄ“ng yÃ¬", zhuin: "ã„—ã„¨ã„›Ë‹ ã„•ã„¥ ã„§Ë‹" },
            ]
          },
          3: {
            title: "ç¬¬ä¸‰èª²ï¼šå»è¶…ç´šå¸‚å ´",
            words: [
              { id: "3-1", chinese: "å†°æ·‡æ·‹", pinyin: "bÄ«ng qÃ­ lÃ­n", zhuin: "ã„…ã„§ã„¥ ã„‘ã„§ËŠ ã„Œã„§ã„£ËŠ" },
              { id: "3-2", chinese: "è¶…ç´šå¸‚å ´", pinyin: "chÄo jÃ­ shÃ¬ chÇng", zhuin: "ã„”ã„  ã„ã„§ËŠ ã„•Ë‹ ã„”ã„¤Ë‡" },
              { id: "3-3", chinese: "æ±è¥¿", pinyin: "dÅng xi", zhuin: "ã„‰ã„¨ã„¥ ã„’ã„§Ë™" },
              { id: "3-4", chinese: "é™„è¿‘", pinyin: "fÃ¹ jÃ¬n", zhuin: "ã„ˆã„¨Ë‹ ã„ã„§ã„£Ë‹" },
              { id: "3-5", chinese: "å¯ä»¥", pinyin: "kÄ› yÇ", zhuin: "ã„ã„œË‡ ã„§Ë‡" },
              { id: "3-6", chinese: "ç±³", pinyin: "mÇ", zhuin: "ã„‡ã„§Ë‡" },
              { id: "3-7", chinese: "è²·", pinyin: "mÇi", zhuin: "ã„‡ã„Ë‡" },
              { id: "3-8", chinese: "ç‰›è‚‰", pinyin: "niÃº rÃ²u", zhuin: "ã„‹ã„§ã„¡ËŠ ã„–ã„¡Ë‹" },
              { id: "3-9", chinese: "å·§å…‹åŠ›", pinyin: "qiÇo kÃ¨ lÃ¬", zhuin: "ã„‘ã„§ã„ Ë‡ ã„ã„œË‹ ã„Œã„§Ë‹" },
              { id: "3-10", chinese: "é’èœ", pinyin: "qÄ«ng cÃ i", zhuin: "ã„‘ã„§ã„¥ ã„˜ã„Ë‹" },
              { id: "3-11", chinese: "ç³–æœ", pinyin: "tÃ¡ng guÇ’", zhuin: "ã„Šã„¤ËŠ ã„ã„¨ã„›Ë‡" },
              { id: "3-12", chinese: "è¦", pinyin: "yÃ o", zhuin: "ã„§ã„ Ë‹" },
              { id: "3-13", chinese: "é­š", pinyin: "yÃº", zhuin: "ã„©ËŠ" },
            ]
          },
          4: {
            title: "ç¬¬å››èª²ï¼šæˆ‘æƒ³åƒæ¼¢å ¡",
            words: [
              { id: "4-1", chinese: "å‡ºå»", pinyin: "chÅ« qÃ¹", zhuin: "ã„”ã„¨ ã„‘ã„©Ë‹" },
              { id: "4-2", chinese: "è›‹ç‚’é£¯", pinyin: "dÃ n chÇo fÃ n", zhuin: "ã„‰ã„¢Ë‹ ã„”ã„ Ë‡ ã„ˆã„¢Ë‹" },
              { id: "4-3", chinese: "é¤“", pinyin: "Ã¨", zhuin: "ã„œË‹" },
              { id: "4-4", chinese: "æ¼¢å ¡", pinyin: "hÃ n bÇo", zhuin: "ã„ã„¢Ë‹ ã„…ã„ Ë‡" },
              { id: "4-5", chinese: "å¿«é»", pinyin: "kuÃ i diÇn", zhuin: "ã„ã„¨ã„Ë‹ ã„‰ã„§ã„¢Ë‡" },
              { id: "4-6", chinese: "äº†", pinyin: "le", zhuin: "ã„Œã„œË™" },
              { id: "4-7", chinese: "éºµ", pinyin: "miÃ n", zhuin: "ã„‡ã„§ã„¢Ë‹" },
              { id: "4-8", chinese: "è–¯æ¢", pinyin: "shÇ” tiÃ¡o", zhuin: "ã„•ã„¨Ë‡ ã„Šã„§ã„ ËŠ" },
              { id: "4-9", chinese: "æ¹¯", pinyin: "tÄng", zhuin: "ã„Šã„¤" },
              { id: "4-10", chinese: "æ™šé¤", pinyin: "wÇn cÄn", zhuin: "ã„¨ã„¢Ë‡ ã„˜ã„¢" },
              { id: "4-11", chinese: "æ™šé£¯", pinyin: "wÇn fÃ n", zhuin: "ã„¨ã„¢Ë‡ ã„ˆã„¢Ë‹" },
              { id: "4-12", chinese: "å…ˆ", pinyin: "xiÄn", zhuin: "ã„’ã„§ã„¢" },
              { id: "4-13", chinese: "å·²ç¶“", pinyin: "yÇ jÄ«ng", zhuin: "ã„§Ë‡ ã„ã„§ã„¥" },
              { id: "4-14", chinese: "ç‰ç±³", pinyin: "yÃ¹ mÇ", zhuin: "ã„©Ë‹ ã„‡ã„§Ë‡" },
              { id: "4-15", chinese: "å†", pinyin: "zÃ i", zhuin: "ã„—ã„Ë‹" },
              { id: "4-16", chinese: "é€±æœ«", pinyin: "zhÅu mÃ²", zhuin: "ã„“ã„¡ ã„‡ã„›Ë‹" },
            ]
          },
          5: {
            title: "ç¬¬äº”èª²ï¼šç§‹å¤©å¿«åˆ°äº†",
            words: [
              { id: "5-1", chinese: "è®Š", pinyin: "biÃ n", zhuin: "ã„…ã„§ã„¢Ë‹" },
              { id: "5-2", chinese: "ä¸éŒ¯", pinyin: "bÃº cuÃ²", zhuin: "ã„…ã„¨ËŠ ã„˜ã„¨ã„›Ë‹" },
              { id: "5-3", chinese: "ç™½è‰²", pinyin: "bÃ¡i sÃ¨", zhuin: "ã„…ã„ËŠ ã„™ã„œË‹" },
              { id: "5-4", chinese: "æ˜¥å¤©", pinyin: "chÅ«n tiÄn", zhuin: "ã„”ã„¨ã„£ ã„Šã„§ã„¢" },
              { id: "5-5", chinese: "è‰", pinyin: "cÇo", zhuin: "ã„˜ã„ Ë‡" },
              { id: "5-6", chinese: "ç´…è‰²", pinyin: "hÃ³ng sÃ¨", zhuin: "ã„ã„¨ã„¥ËŠ ã„™ã„œË‹" },
              { id: "5-7", chinese: "é»ƒ", pinyin: "huÃ¡ng", zhuin: "ã„ã„¨ã„¤ËŠ" },
              { id: "5-8", chinese: "é‚„æ˜¯", pinyin: "hÃ¡i shÃ¬", zhuin: "ã„ã„ËŠ ã„•Ë‹" },
              { id: "5-9", chinese: "èŠ±", pinyin: "huÄ", zhuin: "ã„ã„¨ã„š" },
              { id: "5-10", chinese: "äº†", pinyin: "le", zhuin: "ã„Œã„œË™" },
              { id: "5-11", chinese: "ç¶ è‰²", pinyin: "lÇœ sÃ¨", zhuin: "ã„Œã„©Ë‹ ã„™ã„œË‹" },
              { id: "5-12", chinese: "æ¼‚äº®", pinyin: "piÃ o liÃ ng", zhuin: "ã„†ã„§ã„ Ë‹ ã„Œã„§ã„¤Ë‹" },
              { id: "5-13", chinese: "ç§‹å¤©", pinyin: "qiÅ« tiÄn", zhuin: "ã„‘ã„§ã„¡ ã„Šã„§ã„¢" },
              { id: "5-14", chinese: "æ™‚å€™", pinyin: "shÃ­ hÃ²u", zhuin: "ã„•ËŠ ã„ã„¡Ë‹" },
              { id: "5-15", chinese: "æ¨¹è‘‰", pinyin: "shÃ¹ yÃ¨", zhuin: "ã„•ã„¨Ë‹ ã„§ã„Ë‹" },
              { id: "5-16", chinese: "å¤©æ°£", pinyin: "tiÄn qÃ¬", zhuin: "ã„Šã„§ã„¢ ã„‘ã„§Ë‹" },
              { id: "5-17", chinese: "é™¢å­", pinyin: "yuÃ n zi", zhuin: "ã„©ã„¢Ë‹ ã„—Ë™" },
              { id: "5-18", chinese: "é¡è‰²", pinyin: "yÃ¡n sÃ¨", zhuin: "ã„§ã„¢ËŠ ã„™ã„œË‹" },
              { id: "5-19", chinese: "èˆ’æœ", pinyin: "shÅ« fÃº", zhuin: "ã„•ã„¨ ã„ˆã„¨ËŠ" },
            ]
          },
          6: {
            title: "ç¬¬å…­èª²ï¼šè¾²æ›†æ–°å¹´",
            words: [
              { id: "6-1", chinese: "æ‹œå¹´", pinyin: "bÃ i niÃ¡n", zhuin: "ã„…ã„Ë‹ ã„‹ã„§ã„¢ËŠ" },
              { id: "6-2", chinese: "æ”¾é­ç‚®", pinyin: "fÃ ng biÄn pÃ o", zhuin: "ã„ˆã„¤Ë‹ ã„…ã„§ã„¢ ã„†ã„ Ë‹" },
              { id: "6-3", chinese: "çµ¦", pinyin: "gÄ›i", zhuin: "ã„ã„ŸË‡" },
              { id: "6-4", chinese: "ç´…åŒ…", pinyin: "hÃ³ng bÄo", zhuin: "ã„ã„¨ã„¥ËŠ ã„…ã„ " },
              { id: "6-5", chinese: "æœƒ", pinyin: "huÃ¬", zhuin: "ã„ã„¨ã„ŸË‹" },
              { id: "6-6", chinese: "æ¯æ¬¡", pinyin: "mÄ›i cÃ¬", zhuin: "ã„‡ã„ŸË‡ ã„˜Ë‹" },
              { id: "6-7", chinese: "é‚£å¤©", pinyin: "nÃ  tiÄn", zhuin: "ã„‹ã„šË‹ ã„Šã„§ã„¢" },
              { id: "6-8", chinese: "å¹´ç³•", pinyin: "niÃ¡n gÄo", zhuin: "ã„‹ã„§ã„¢ËŠ ã„ã„ " },
              { id: "6-9", chinese: "å¦‚æœ", pinyin: "rÃº guÇ’", zhuin: "ã„–ã„¨ËŠ ã„ã„¨ã„›Ë‡" },
              { id: "6-10", chinese: "èªª", pinyin: "shuÅ", zhuin: "ã„•ã„¨ã„›" },
              { id: "6-11", chinese: "è‡ºç£", pinyin: "TÃ¡i wÄn", zhuin: "ã„Šã„ËŠ ã„¨ã„¢" },
              { id: "6-12", chinese: "è²¼æ˜¥è¯", pinyin: "tiÄ“ chÅ«n liÃ¡n", zhuin: "ã„Šã„§ã„ ã„”ã„¨ã„£ ã„Œã„§ã„¢ËŠ" },
              { id: "6-13", chinese: "æ–°å¹´", pinyin: "xÄ«n niÃ¡n", zhuin: "ã„’ã„§ã„£ ã„‹ã„§ã„¢ËŠ" },
              { id: "6-14", chinese: "æ”¾", pinyin: "fÃ ng", zhuin: "ã„ˆã„¤Ë‹" },
              { id: "6-15", chinese: "æ˜ŸæœŸ", pinyin: "xÄ«ng qÃ­", zhuin: "ã„’ã„§ã„¥ ã„‘ã„§ËŠ" },
              { id: "6-16", chinese: "è¯äºº", pinyin: "HuÃ¡ rÃ©n", zhuin: "ã„ã„¨ã„šËŠ ã„–ã„£ËŠ" },
              { id: "6-17", chinese: "è¾²æ›†", pinyin: "nÃ³ng lÃ¬", zhuin: "ã„‹ã„¨ã„¥ËŠ ã„Œã„§Ë‹" },
            ]
          },
          7: {
            title: "ç¬¬ä¸ƒèª²ï¼šæ—©ä¸€é»ç¡è¦º",
            words: [
              { id: "7-1", chinese: "åˆ¥", pinyin: "biÃ©", zhuin: "ã„…ã„§ã„ËŠ" },
              { id: "7-2", chinese: "è‚¥çš‚", pinyin: "fÃ©i zÃ o", zhuin: "ã„ˆã„ŸËŠ ã„—ã„ Ë‹" },
              { id: "7-3", chinese: "ä¹¾æ·¨", pinyin: "gÄn jÃ¬ng", zhuin: "ã„ã„¢ ã„ã„§ã„¥Ë‹" },
              { id: "7-4", chinese: "è©²", pinyin: "gÄi", zhuin: "ã„ã„" },
              { id: "7-5", chinese: "é", pinyin: "guÃ²", zhuin: "ã„ã„¨ã„›Ë‹" },
              { id: "7-6", chinese: "è¶•å¿«", pinyin: "gÇn kuÃ i", zhuin: "ã„ã„¢Ë‡ ã„ã„¨ã„Ë‹" },
              { id: "7-7", chinese: "ä¾†ä¸åŠ", pinyin: "lÃ¡i bÃ¹ jÃ­", zhuin: "ã„Œã„ËŠ ã„…ã„¨Ë‹ ã„ã„§ËŠ" },
              { id: "7-8", chinese: "ç´¯", pinyin: "lÃ¨i", zhuin: "ã„Œã„ŸË‹" },
              { id: "7-9", chinese: "èµ·åºŠ", pinyin: "qÇ chuÃ¡ng", zhuin: "ã„‘ã„§Ë‡ ã„”ã„¨ã„¤ËŠ" },
              { id: "7-10", chinese: "åˆ·ç‰™", pinyin: "shuÄ yÃ¡", zhuin: "ã„•ã„¨ã„š ã„§ã„šËŠ" },
              { id: "7-11", chinese: "ç¡è¦º", pinyin: "shuÃ¬ jiÃ o", zhuin: "ã„•ã„¨ã„ŸË‹ ã„ã„§ã„ Ë‹" },
              { id: "7-12", chinese: "æ™šä¸Š", pinyin: "wÇn shÃ ng", zhuin: "ã„¨ã„¢Ë‡ ã„•ã„¤Ë‹" },
              { id: "7-13", chinese: "å¿˜", pinyin: "wÃ ng", zhuin: "ã„¨ã„¤Ë‹" },
              { id: "7-14", chinese: "æ´—", pinyin: "xÇ", zhuin: "ã„’ã„§Ë‡" },
              { id: "7-15", chinese: "æ´—æ¾¡", pinyin: "xÇ zÇo", zhuin: "ã„’ã„§Ë‡ ã„—ã„ Ë‡" },
              { id: "7-16", chinese: "æ´—è‡‰", pinyin: "xÇ liÇn", zhuin: "ã„’ã„§Ë‡ ã„Œã„§ã„¢Ë‡" },
              { id: "7-17", chinese: "ç”¨", pinyin: "yÃ²ng", zhuin: "ã„©ã„¥Ë‹" },
              { id: "7-18", chinese: "çŸ¥é“", pinyin: "zhÄ« dÃ o", zhuin: "ã„“ ã„‰ã„ Ë‹" },
              { id: "7-19", chinese: "æ˜¨å¤©", pinyin: "zuÃ³ tiÄn", zhuin: "ã„—ã„¨ã„›ËŠ ã„Šã„§ã„¢" },
            ]
          },
          8: {
            title: "ç¬¬å…«èª²ï¼šæˆ‘çš„å¯µç‰©",
            words: [
              { id: "8-1", chinese: "ä¸è¦‹äº†", pinyin: "bÃº jiÃ n le", zhuin: "ã„…ã„¨ËŠ ã„ã„§ã„¢Ë‹ ã„Œã„œË™" },
              { id: "8-2", chinese: "å¯µç‰©", pinyin: "chÇ’ng wÃ¹", zhuin: "ã„”ã„¨ã„¥Ë‡ ã„¨Ë‹" },
              { id: "8-3", chinese: "å¸¶", pinyin: "dÃ i", zhuin: "ã„‰ã„Ë‹" },
              { id: "8-4", chinese: "éå¸¸", pinyin: "fÄ“i chÃ¡ng", zhuin: "ã„ˆã„Ÿ ã„”ã„¤ËŠ" },
              { id: "8-5", chinese: "é", pinyin: "guÃ²", zhuin: "ã„ã„¨ã„›Ë‹" },
              { id: "8-6", chinese: "ç‹—", pinyin: "gÇ’u", zhuin: "ã„ã„¡Ë‡" },
              { id: "8-7", chinese: "å¯æ„›", pinyin: "kÄ› Ã i", zhuin: "ã„ã„œË‡ ã„Ë‹" },
              { id: "8-8", chinese: "è²“", pinyin: "mÄo", zhuin: "ã„‡ã„ " },
              { id: "8-9", chinese: "å»å¹´", pinyin: "qÃ¹ niÃ¡n", zhuin: "ã„‘ã„©Ë‹ ã„‹ã„§ã„¢ËŠ" },
              { id: "8-10", chinese: "é€çµ¦", pinyin: "sÃ²ng gÄ›i", zhuin: "ã„™ã„¨ã„¥Ë‹ ã„ã„ŸË‡" },
              { id: "8-11", chinese: "ä¸Šå€‹æœˆ", pinyin: "shÃ ng ge yuÃ¨", zhuin: "ã„•ã„¤Ë‹ ã„ã„œË™ ã„©ã„Ë‹" },
              { id: "8-12", chinese: "ç‰ å€‘", pinyin: "tÄ men", zhuin: "ã„Šã„š ã„‡ã„£Ë™" },
              { id: "8-13", chinese: "å…”å­", pinyin: "tÃ¹ zi", zhuin: "ã„Šã„¨Ë‹ ã„—Ë™" },
              { id: "8-14", chinese: "é¤µ", pinyin: "wÃ¨i", zhuin: "ã„¨ã„ŸË‹" },
              { id: "8-15", chinese: "é¤Š", pinyin: "yÇng", zhuin: "ã„§ã„¤Ë‡" },
              { id: "8-16", chinese: "éš»", pinyin: "zhÄ«", zhuin: "ã„“" },
              { id: "8-17", chinese: "æ•£æ­¥", pinyin: "sÃ n bÃ¹", zhuin: "ã„™ã„¢Ë‹ ã„…ã„¨Ë‹" },
            ]
          },
          9: {
            title: "ç¬¬ä¹èª²ï¼šéŸ³æ¨‚æ•™å®¤åœ¨åŒ—æ–¹",
            words: [
              { id: "9-1", chinese: "åŒ—æ–¹", pinyin: "bÄ›i fÄng", zhuin: "ã„…ã„ŸË‡ ã„ˆã„¤" },
              { id: "9-2", chinese: "é‚„æ˜¯", pinyin: "hÃ¡i shÃ¬", zhuin: "ã„ã„ËŠ ã„•Ë‹" },
              { id: "9-3", chinese: "æ±æ–¹", pinyin: "dÅng fÄng", zhuin: "ã„‰ã„¨ã„¥ ã„ˆã„¤" },
              { id: "9-4", chinese: "æ–¹å‘", pinyin: "fÄng xiÃ ng", zhuin: "ã„ˆã„¤ ã„’ã„§ã„¤Ë‹" },
              { id: "9-5", chinese: "å‘Šè¨´", pinyin: "gÃ o sÃ¹", zhuin: "ã„ã„ Ë‹ ã„™ã„¨Ë‹" },
              { id: "9-6", chinese: "æ•™å®¤", pinyin: "jiÃ o shÃ¬", zhuin: "ã„ã„§ã„ Ë‹ ã„•Ë‹" },
              { id: "9-7", chinese: "å—æ–¹", pinyin: "nÃ¡n fÄng", zhuin: "ã„‹ã„¢ËŠ ã„ˆã„¤" },
              { id: "9-8", chinese: "æ‰€ä»¥", pinyin: "suÇ’ yÇ", zhuin: "ã„™ã„¨ã„›Ë‡ ã„§Ë‡" },
              { id: "9-9", chinese: "å®ƒ", pinyin: "tÄ", zhuin: "ã„Šã„š" },
              { id: "9-10", chinese: "æ ¡é–€å£", pinyin: "xiÃ o mÃ©n kÇ’u", zhuin: "ã„’ã„§ã„ Ë‹ ã„‡ã„£ËŠ ã„ã„¡Ë‡" },
              { id: "9-11", chinese: "è¥¿æ–¹", pinyin: "xÄ« fÄng", zhuin: "ã„’ã„§ ã„ˆã„¤" },
              { id: "9-12", chinese: "å› ç‚º", pinyin: "yÄ«n wÃ¨i", zhuin: "ã„§ã„£ ã„¨ã„ŸË‹" },
              { id: "9-13", chinese: "è¶³çƒå ´", pinyin: "zÃº qiÃº chÇng", zhuin: "ã„—ã„¨ËŠ ã„‘ã„§ã„¡ËŠ ã„”ã„¤Ë‡" },
              { id: "9-14", chinese: "æŒ‡åŒ—é‡", pinyin: "zhÇ bÄ›i zhÄ“n", zhuin: "ã„“Ë‡ ã„…ã„ŸË‡ ã„“ã„£" },
              { id: "9-15", chinese: "æŒ‡å—é‡", pinyin: "zhÇ nÃ¡n zhÄ“n", zhuin: "ã„“Ë‡ ã„‹ã„¢ËŠ ã„“ã„£" },
            ]
          },
          10: {
            title: "ç¬¬åèª²ï¼šå¤–å…¬ã€å¤–å©†ä½åœ¨è‡ºç£",
            words: [
              { id: "10-1", chinese: "æœ¬ä¾†", pinyin: "bÄ›n lÃ¡i", zhuin: "ã„…ã„£Ë‡ ã„Œã„ËŠ" },
              { id: "10-2", chinese: "æ³•åœ‹", pinyin: "FÇ guÃ³", zhuin: "ã„ˆã„šË‡ ã„ã„¨ã„›ËŠ" },
              { id: "10-3", chinese: "èˆ…èˆ…", pinyin: "jiÃ¹ jiu", zhuin: "ã„ã„§ã„¡Ë‹ ã„ã„§ã„¡Ë™" },
              { id: "10-4", chinese: "çœ‹", pinyin: "kÃ n", zhuin: "ã„ã„¢Ë‹" },
              { id: "10-5", chinese: "æ—…è¡Œ", pinyin: "lÇš xÃ­ng", zhuin: "ã„Œã„©Ë‡ ã„’ã„§ã„¥ËŠ" },
              { id: "10-6", chinese: "ç´ç´„", pinyin: "NiÇ” yuÄ“", zhuin: "ã„‹ã„§ã„¡Ë‡ ã„©ã„" },
              { id: "10-7", chinese: "è‡ºåŒ—", pinyin: "TÃ¡i bÄ›i", zhuin: "ã„Šã„ËŠ ã„…ã„ŸË‡" },
              { id: "10-8", chinese: "è‡ºå—", pinyin: "TÃ¡i nÃ¡n", zhuin: "ã„Šã„ËŠ ã„‹ã„¢ËŠ" },
              { id: "10-9", chinese: "é€€ä¼‘", pinyin: "tuÃ¬ xiÅ«", zhuin: "ã„Šã„¨ã„ŸË‹ ã„’ã„§ã„¡" },
              { id: "10-10", chinese: "ä¸€æ¬¡", pinyin: "yÃ­ cÃ¬", zhuin: "ã„§ËŠ ã„˜Ë‹" },
              { id: "10-11", chinese: "ä½åœ¨", pinyin: "zhÃ¹ zÃ i", zhuin: "ã„“ã„¨Ë‹ ã„—ã„Ë‹" },
              { id: "10-12", chinese: "æš‘å‡", pinyin: "shÇ” jiÃ ", zhuin: "ã„•ã„¨Ë‡ ã„ã„§ã„šË‹" },
            ]
          },
          11: {
            title: "ç¬¬åä¸€èª²ï¼šå»å‹•ç‰©åœ’",
            words: [
              { id: "11-1", chinese: "ä¸ä½†", pinyin: "bÃº dÃ n", zhuin: "ã„…ã„¨ËŠ ã„‰ã„¢Ë‹" },
              { id: "11-2", chinese: "è„–å­", pinyin: "bÃ³ zi", zhuin: "ã„…ã„›ËŠ ã„—Ë™" },
              { id: "11-3", chinese: "é•·é ¸é¹¿", pinyin: "chÃ¡ng jÇng lÃ¹", zhuin: "ã„”ã„¤ËŠ ã„ã„§ã„¥Ë‡ ã„Œã„¨Ë‹" },
              { id: "11-4", chinese: "å¤§è±¡", pinyin: "dÃ  xiÃ ng", zhuin: "ã„‰ã„šË‹ ã„’ã„§ã„¤Ë‹" },
              { id: "11-5", chinese: "å‹•ç‰©åœ’", pinyin: "dÃ²ng wÃ¹ yuÃ¡n", zhuin: "ã„‰ã„¨ã„¥Ë‹ ã„¨Ë‹ ã„©ã„¢ËŠ" },
              { id: "11-6", chinese: "çŒ´å­", pinyin: "hÃ³u zi", zhuin: "ã„ã„¡ËŠ ã„—Ë™" },
              { id: "11-7", chinese: "çœ‹åˆ°", pinyin: "kÃ n dÃ o", zhuin: "ã„ã„¢Ë‹ ã„‰ã„ Ë‹" },
              { id: "11-8", chinese: "è€è™", pinyin: "lÇo hÇ”", zhuin: "ã„Œã„ Ë‡ ã„ã„¨Ë‡" },
              { id: "11-9", chinese: "èƒ–", pinyin: "pÃ ng", zhuin: "ã„†ã„¤Ë‹" },
              { id: "11-10", chinese: "ä¼éµ", pinyin: "qÃ¬ Ã©", zhuin: "ã„‘ã„§Ë‹ ã„œËŠ" },
              { id: "11-11", chinese: "ç©", pinyin: "wÃ¡n", zhuin: "ã„¨ã„¢ËŠ" },
      { id: "11-12", chinese: "ç†Šè²“", pinyin: "xiÃ³ng mÄo", zhuin: "ã„’ã„©ã„¥ËŠ ã„‡ã„ " },
              { id: "11-13", chinese: "å¸Œæœ›", pinyin: "xÄ« wÃ ng", zhuin: "ã„’ã„§ ã„¨ã„¤Ë‹" },
              { id: "11-14", chinese: "é€™ä¸€æ¬¡", pinyin: "zhÃ¨ yÃ­ cÃ¬", zhuin: "ã„“ã„œË‹ ã„§ËŠ ã„˜Ë‹" },
              { id: "11-15", chinese: "é•·", pinyin: "chÃ¡ng", zhuin: "ã„”ã„¤ËŠ" },
              { id: "11-16", chinese: "çœŸ", pinyin: "zhÄ“n", zhuin: "ã„“ã„£" },
            ]
          },
          12: {
            title: "ç¬¬åäºŒèª²ï¼šæ‰“ç¶²è·¯é›»è©±",
            words: [
              { id: "12-1", chinese: "å•Š", pinyin: "a", zhuin: "ã„šË™" },
              { id: "12-2", chinese: "éä¾†", pinyin: "guÃ² lÃ¡i", zhuin: "ã„ã„¨ã„›Ë‹ ã„Œã„ËŠ" },
              { id: "12-3", chinese: "å¾ˆä¹…", pinyin: "hÄ›n jiÇ”", zhuin: "ã„ã„£Ë‡ ã„ã„§ã„¡Ë‡" },
              { id: "12-4", chinese: "å¥½å¥½", pinyin: "hÇo hÇo", zhuin: "ã„ã„ Ë‡ ã„ã„ Ë‡" },
              { id: "12-5", chinese: "çœ‹èµ·ä¾†", pinyin: "kÃ n qÇ lÃ¡i", zhuin: "ã„ã„¢Ë‹ ã„‘ã„§Ë‡ ã„Œã„ËŠ" },
              { id: "12-6", chinese: "æ²’å•é¡Œ", pinyin: "mÃ©i wÃ¨n tÃ­", zhuin: "ã„‡ã„ŸËŠ ã„¨ã„£Ë‹ ã„Šã„§ËŠ" },
              { id: "12-7", chinese: "ä¸Šèª²", pinyin: "shÃ ng kÃ¨", zhuin: "ã„•ã„¤Ë‹ ã„ã„œË‹" },
              { id: "12-8", chinese: "èªªè©±", pinyin: "shuÅ huÃ ", zhuin: "ã„•ã„¨ã„› ã„ã„¨ã„šË‹" },
              { id: "12-9", chinese: "ç˜¦", pinyin: "shÃ²u", zhuin: "ã„•ã„¡Ë‹" },
              { id: "12-10", chinese: "ç¶²è·¯", pinyin: "wÇng lÃ¹", zhuin: "ã„¨ã„¤Ë‡ ã„Œã„¨Ë‹" },
              { id: "12-11", chinese: "å¯«", pinyin: "xiÄ›", zhuin: "ã„’ã„§ã„Ë‡" },
              { id: "12-12", chinese: "ä¿¡", pinyin: "xÃ¬n", zhuin: "ã„’ã„§ã„£Ë‹" },
              { id: "12-13", chinese: "æœ‰æ„æ€", pinyin: "yÇ’u yÃ¬ si", zhuin: "ã„§ã„¡Ë‡ ã„§Ë‹ ã„™Ë™" },
              { id: "12-14", chinese: "ä¸€å®š", pinyin: "yÃ­ dÃ¬ng", zhuin: "ã„§ËŠ ã„‰ã„§ã„¥Ë‹" },
              { id: "12-15", chinese: "å½±åƒ", pinyin: "yÇng xiÃ ng", zhuin: "ã„§ã„¥Ë‡ ã„’ã„§ã„¤Ë‹" },
              { id: "12-16", chinese: "é•·é«˜", pinyin: "zhÇng gÄo", zhuin: "ã„“ã„¤Ë‡ ã„ã„ " },
              { id: "12-17", chinese: "é›»è©±", pinyin: "diÃ n huÃ ", zhuin: "ã„‰ã„§ã„¢Ë‹ ã„ã„¨ã„šË‹" },
            ]
          }
        };

        // ç¶œåˆæ‰€æœ‰èª²ç¨‹çš„è³‡æ–™
        const ALL_WORDS_FALLBACK = Object.values(DEFAULT_LESSON_DATA).flatMap(lesson => lesson.words);

        // --- éŠæˆ²åƒæ•¸è¨­å®š (é›£åº¦çµ„æ…‹) ---
        const DIFFICULTY_SETTINGS = {
            slow: { 
                id: 'slow', 
                label: 'ğŸ¢ æ…¢æ…¢çš„', 
                subLabel: 'é©åˆé–±è®€', 
                bg: 'bg-green-500', 
                speedBase: 0.15,    // åŸºç¤æ‰è½é€Ÿåº¦ (åŸ 0.2)
                spawnRate: 4000,   // åˆå§‹ç”Ÿæˆé–“éš” (åŸ 3500)
                minRate: 2500,      // æœ€å¿«ç”Ÿæˆé–“éš”é™åˆ¶ (åŸ 2000)
                character: 'ğŸ¢',     // é€²åº¦æ¢è§’è‰²
                startIcon: 'ğŸ',
                endIcon: 'ğŸ¥¬'
            },
            normal: { 
                id: 'normal', 
                label: 'ğŸ‡ æ™®é€šé€Ÿåº¦', 
                subLabel: 'æœ‰é»åˆºæ¿€', 
                bg: 'bg-blue-500', 
                speedBase: 0.25,   // (åŸ 0.35)
                spawnRate: 2500,   // (åŸ 2000)
                minRate: 1500,      // (åŸ 1200)
                character: 'ğŸ‡',     // é€²åº¦æ¢è§’è‰²
                startIcon: 'ğŸŒ²',
                endIcon: 'ğŸ¥•'
            },
            fast: { 
                id: 'fast', 
                label: 'ğŸ† å¿«å¿«çš„', 
                subLabel: 'è¶…ç´šæŒ‘æˆ°', 
                bg: 'bg-red-500', 
                speedBase: 0.4,    // å¤§å¹…èª¿æ…¢ (åŸ 0.6)
                spawnRate: 1600,   // (åŸ 1200)
                minRate: 900,       // (åŸ 600)
                character: 'ğŸš€',     // é€²åº¦æ¢è§’è‰²
                startIcon: 'ğŸŒ',
                endIcon: 'ğŸŒ•'
            }
        };

        const GAME_WIDTH_PCT = 85;

        function ChineseFallingGame() {
          const [gameState, setGameState] = useState('menu');
          const [selectedLessonId, setSelectedLessonId] = useState(null); 
          // æ–°å¢ï¼šé›£åº¦é¸æ“‡ç‹€æ…‹ï¼Œé è¨­ç‚ºã€Œæ…¢æ…¢çš„ã€
          const [currentDifficulty, setCurrentDifficulty] = useState('slow'); 
          // æ–°å¢ï¼šèƒŒæ™¯ç”Ÿè©ç‹€æ…‹
          const [bgWords, setBgWords] = useState([]);
          // æ–°å¢ï¼šå—å‚·ç´…å±ç‹€æ…‹
          const [damageFlash, setDamageFlash] = useState(false);

          const [customData, setCustomData] = useState([]); 
          const [customInputText, setCustomInputText] = useState(
            "æ—©å®‰, zÇo Än, ã„—ã„ Ë‡ ã„¢\nå­¸æ ¡, xuÃ© xiÃ o, ã„’ã„©ã„ËŠ ã„’ã„§ã„ Ë‹\næœ‹å‹, pÃ©ng yÇ’u, ã„†ã„¥ËŠ ã„§ã„¡Ë‡"
          );
          
          const [score, setScore] = useState(0);
          const [lives, setLives] = useState(3); // ä¿®æ”¹ï¼šåˆå§‹ç”Ÿå‘½å€¼æ”¹ç‚º 3
          const [options, setOptions] = useState([]); 
          const [targetWordId, setTargetWordId] = useState(null);
          // Remove state based fallingWords for logic, use only for rendering
          const [fallingWords, setFallingWords] = useState([]); 
          const [hitEffect, setHitEffect] = useState(null);
          const [countdown, setCountdown] = useState(3);
          const [combo, setCombo] = useState(0);
          const [bottomWarn, setBottomWarn] = useState(false);
          const [prevGameState, setPrevGameState] = useState('menu');
          const [shareUrl, setShareUrl] = useState('');
          const [showShareToast, setShowShareToast] = useState(false);
          
          // Added: New state for reward (gift box)
          const [isRewardOpened, setIsRewardOpened] = useState(false);

          // Added: New state for player name
          const [playerName, setPlayerName] = useState("");

          // UI Only States for display
          const [currentStageDisplay, setCurrentStageDisplay] = useState(0);
          const [masteredCountDisplay, setMasteredCountDisplay] = useState(0);
          const [stageGoalDisplay, setStageGoalDisplay] = useState(0);

          // Refs for Game Logic (Sources of Truth)
          const requestRef = useRef();
          const containerRef = useRef(null); // Reference for main game container
          const stateRef = useRef({
            fallingWords: [], // Array of word objects
            isPlaying: false,
            lastTime: 0,
            spawnTimer: 0,
            score: 0,
            currentLessonWords: [],
            title: "",
            masteredWords: new Set(),
            wrongWordIds: new Set(),
            currentStage: 0,
            stageGoals: [],
            combo: 0,
            // æ–°å¢ï¼šå°‡ç•¶å‰é›£åº¦è¨­å®šå­˜å…¥ Refï¼Œä¾›éŠæˆ²è¿´åœˆè®€å–
            settings: DIFFICULTY_SETTINGS.slow 
          });

          // Check URL params on mount
          useEffect(() => {
            const params = new URLSearchParams(window.location.search);
            const lessonParam = params.get('lesson');
            
            if (lessonParam && DEFAULT_LESSON_DATA[lessonParam]) {
                setSelectedLessonId(lessonParam);
                setGameState('singleLessonIntro');
            }
          }, []);

          // è§¸ç™¼å—å‚·æ•ˆæœ
          const triggerDamage = () => {
              setDamageFlash(true);
              setTimeout(() => setDamageFlash(false), 300);
          };

          const parseCustomInput = (text) => {
            const lines = text.split('\n');
            const parsed = [];
            lines.forEach((line, index) => {
              const parts = line.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
              if (parts.length >= 3) {
                parsed.push({
                  id: `custom-${index}`,
                  chinese: parts[0],
                  pinyin: parts[1],
                  zhuin: parts[2]
                });
              }
            });
            return parsed;
          };

          const speak = (text) => {
            if ('speechSynthesis' in window) {
              window.speechSynthesis.cancel();
              const utterance = new SpeechSynthesisUtterance(text);
              
              // 1. å¼·åˆ¶è¨­å®šèªè¨€ä»£ç¢¼
              utterance.lang = 'zh-TW';
              utterance.rate = 0.8; // ç¨å¾®æ”¾æ…¢ä¸€é»ï¼Œé©åˆæ•™å­¸

              // 2. å¼·åˆ¶å°‹æ‰¾ä¸¦æŒ‡å®šä¸­æ–‡èªéŸ³åŒ… (è§£æ±ºç³»çµ±é è¨­ç‚ºæ—¥æ–‡çš„å•é¡Œ)
              const voices = window.speechSynthesis.getVoices();
              
              // å„ªå…ˆæ‰¾å°ç£ç¹é«”ä¸­æ–‡ (zh-TW)
              let targetVoice = voices.find(v => 
                  v.lang.replace('_', '-').toLowerCase() === 'zh-tw' || 
                  v.name.includes('Taiwan')
              );

              // æ‰¾ä¸åˆ°å‰‡æ‰¾ä»»æ„ä¸­æ–‡ (zh)
              if (!targetVoice) {
                  targetVoice = voices.find(v => v.lang.toLowerCase().startsWith('zh'));
              }

              // å¦‚æœæœ‰æ‰¾åˆ°ä¸­æ–‡èªéŸ³åŒ…ï¼Œå°±å¼·åˆ¶æŒ‡å®š
              if (targetVoice) {
                  utterance.voice = targetVoice;
              }

              window.speechSynthesis.speak(utterance);
            }
          };

          const generateOptions = useCallback((correctWord) => {
            if (!correctWord) return [];
            
            let pool = stateRef.current.currentLessonWords;
            if (pool.length < 3) {
              pool = [...pool, ...ALL_WORDS_FALLBACK];
            }

            const distractors = pool
              .filter(item => item.chinese !== correctWord.chinese)
              .sort(() => 0.5 - Math.random())
              .slice(0, 2);

            const newOptions = [
              { ...correctWord, isCorrect: true },
              ...distractors.map(d => ({ ...d, isCorrect: false, wordId: d.id }))
            ];

            return newOptions.sort(() => 0.5 - Math.random());
          }, []);

          // Updated spawnWord to only update Ref, avoiding conflict with gameLoop render
          const spawnWord = useCallback(() => {
            const { currentLessonWords, masteredWords, fallingWords, currentStage, score, settings } = stateRef.current;

            const candidates = currentLessonWords.filter(w => 
              !masteredWords.has(w.id) && 
              !fallingWords.some(fw => fw.wordId === w.id)
            );

            if (candidates.length === 0) return;

            const randomItem = candidates[Math.floor(Math.random() * candidates.length)];
            
            // Adjusted range to prevent clipping on left/right edges
            // Was: Math.random() * (GAME_WIDTH_PCT - 15) + 5;
            // New: Range from 15% to 85% to accommodate wider words centered at X
            const randomX = Math.random() * 70 + 15; 
            
            // Slower stage multiplier (was 0.125, now 0.1 to slow down progression every 3 stages)
            const speedLevel = Math.floor(currentStage / 3);
            const stageMultiplier = 1 + (speedLevel * 0.1); 
            
            // ä¿®æ”¹ï¼šä½¿ç”¨ settings ä¸­çš„ speedBase
            const finalSpeed = Math.min(settings.speedBase * 2.5, settings.speedBase * stageMultiplier);

            // 5% æ©Ÿç‡å‡ºç¾é»ƒé‡‘çå‹µå­— (Bonus)
            const isBonus = Math.random() < 0.05;

            const newWord = {
              id: Date.now() + Math.random(),
              wordId: randomItem.id,
              chinese: randomItem.chinese,
              pinyin: randomItem.pinyin,
              zhuin: randomItem.zhuin,
              x: randomX,
              y: -15,
              speed: finalSpeed,
              isBonus: isBonus // æ¨™è¨˜æ˜¯å¦ç‚ºçå‹µå­—
            };

            // Only push to Ref, let loop handle the state update
            stateRef.current.fallingWords.push(newWord);
          }, []);

          const endStage = (stageIndex) => {
            stateRef.current.isPlaying = false;
            if (requestRef.current) cancelAnimationFrame(requestRef.current);
            
            const goals = stateRef.current.stageGoals;
            if (stageIndex >= goals.length - 1) {
              // Changed: Do NOT play victory sound yet
              // Reset opened state for the new victory
              setIsRewardOpened(false); 
              setGameState('victory');
            } else {
              setGameState('stageClear');
            }
          };

          const gameLoop = useCallback((time) => {
            if (!stateRef.current.isPlaying) return;

            if (stateRef.current.lastTime === 0) {
              stateRef.current.lastTime = time;
              stateRef.current.spawnTimer = time;
            }

            let deltaTime = time - stateRef.current.lastTime;
            if (deltaTime > 100) deltaTime = 16;
            
            stateRef.current.lastTime = time;

            const { currentStage, score, fallingWords: currentFallingWords, settings } = stateRef.current;
            
            // Slower spawn rate increase
            const speedLevel = Math.floor(currentStage / 3);
            const stageRateMod = speedLevel * 100; // Reduce 100ms every 3 stages
            
            // ä¿®æ”¹ï¼šä½¿ç”¨ settings ä¸­çš„ spawnRate å’Œ minRate
            let currentRate = Math.max(settings.minRate, settings.spawnRate - (score * 2) - stageRateMod);
            
            if (currentFallingWords.length === 0) {
              currentRate = 500;
            }

            if (time - stateRef.current.spawnTimer > currentRate) {
              spawnWord();
              stateRef.current.spawnTimer = time;
            }

            let nextWords = [];
            let livesLostCount = 0;
            let lowestWord = null;
            let maxY = -100;

            // IMMUTABLE UPDATE PATTERN: Create new objects for moved words
            stateRef.current.fallingWords.forEach(word => {
              // Calculate new Y position
              const newY = word.y + word.speed * (deltaTime / 16);

              if (newY > maxY) {
                maxY = newY;
                lowestWord = word;
              }

              if (newY > 78) {
                livesLostCount++;
                stateRef.current.wrongWordIds.add(word.wordId);
              } else {
                // Create NEW object to force React to re-render
                nextWords.push({ ...word, y: newY });
              }
            });

            stateRef.current.fallingWords = nextWords;
            
            setTargetWordId(prevId => {
                if (!lowestWord) return null;
                if (lowestWord.id !== prevId) {
                    setOptions(generateOptions(lowestWord));
                    return lowestWord.id;
                }
                return prevId;
            });

            // Sync to React State for Render
            setFallingWords(nextWords);

            if (livesLostCount > 0) {
              triggerDamage();
              playSound('error');
              setBottomWarn(true);
              setTimeout(() => setBottomWarn(false), 300);

              stateRef.current.spawnTimer = time - currentRate + 100;

              stateRef.current.combo = 0;
              setCombo(0);

              setLives(prev => {
                const newLives = prev - livesLostCount;
                if (newLives <= 0) {
                  stateRef.current.isPlaying = false;
                  setGameState('gameover');
                  return 0;
                }
                return newLives;
              });
            }

            if (stateRef.current.isPlaying) {
                requestRef.current = requestAnimationFrame(gameLoop);
            }
          }, [generateOptions, spawnWord]);

          const handleOptionClick = (option) => {
            speak(option.chinese);

            if (!targetWordId) return;

            const targetWord = stateRef.current.fallingWords.find(w => w.id === targetWordId);
            
            // Add safety check
            if (!targetWord) {
                return;
            }
            
            if (targetWord && (option.wordId === targetWord.wordId || option.chinese === targetWord.chinese)) {
              // CORRECT
              
              // æª¢æŸ¥æ˜¯å¦ç‚º Bonus å­—
              if (targetWord.isBonus) {
                  playSound('heal');
                  setLives(prev => Math.min(3, prev + 1)); // æœ€å¤šè£œåˆ° 3 æ»´è¡€
              } else {
                  playSound('correct');
              }

              setHitEffect({ x: targetWord.x, y: targetWord.y });
              setTimeout(() => setHitEffect(null), 500);

              // Add word to background wall (limit to last 20)
              const newBgWord = {
                  id: targetWord.id + '-bg', // Unique ID
                  text: targetWord.chinese,
                  x: Math.random() * 80 + 10, // 10% to 90%
                  y: Math.random() * 60 + 10, // 10% to 70% (keep it somewhat upper/mid)
                  rotation: Math.random() * 60 - 30, // -30 to 30 deg
                  fontSize: Math.random() * 2 + 2 + 'rem' // Random size
              };
              setBgWords(prev => [...prev, newBgWord].slice(-20)); // Limit to last 20

              const nextWords = stateRef.current.fallingWords.filter(w => w.id !== targetWordId);
              stateRef.current.fallingWords = nextWords;
              setFallingWords(nextWords); 
              
              stateRef.current.masteredWords.add(targetWord.wordId);
              setMasteredCountDisplay(stateRef.current.masteredWords.size);

              // Combo Logic
              const newCombo = stateRef.current.combo + 1;
              stateRef.current.combo = newCombo;
              setCombo(newCombo);

              const comboBonus = Math.floor(newCombo / 5) * 5; 

              setScore(s => {
                  const newScore = s + 10 + comboBonus;
                  stateRef.current.score = newScore;
                  return newScore;
              });

              const { masteredWords, currentStage, stageGoals } = stateRef.current;
              if (masteredWords.size >= stageGoals[currentStage]) {
                 endStage(currentStage);
              }

            } else {
              // WRONG
              triggerDamage(); // è§¸ç™¼ç´…å±
              playSound('error');
              stateRef.current.combo = 0;
              setCombo(0);
              
              stateRef.current.wrongWordIds.add(targetWord.wordId);
              
              // æ–°å¢ï¼šç­”éŒ¯æ‰£é™¤ç”Ÿå‘½å€¼é‚è¼¯
              setLives(prev => {
                const newLives = prev - 1;
                if (newLives <= 0) {
                  stateRef.current.isPlaying = false;
                  setGameState('gameover');
                  return 0;
                }
                return newLives;
              });

              const container = containerRef.current;
              if (container) {
                container.classList.add('animate-shake');
                setTimeout(() => container.classList.remove('animate-shake'), 200); 
              }
            }
          };

          const startCountdown = () => {
            setCountdown(3);
            setGameState('countdown');
          };

          useEffect(() => {
            if (gameState === 'countdown') {
              if (countdown > 0) {
                const timer = setTimeout(() => setCountdown(c => c - 1), 1000);
                return () => clearTimeout(timer);
              } else {
                setGameState('playing');
                stateRef.current.isPlaying = true;
                stateRef.current.lastTime = 0;
                stateRef.current.spawnTimer = 0;
                requestRef.current = requestAnimationFrame(gameLoop);
              }
            }
          }, [gameState, countdown, gameLoop]);

          // Pause Logic
          const togglePause = () => {
            if (gameState === 'playing') {
              stateRef.current.isPlaying = false;
              if (requestRef.current) cancelAnimationFrame(requestRef.current);
              setGameState('paused');
            } else if (gameState === 'paused') {
              setGameState('countdown'); // Resume with countdown
              setCountdown(3);
            }
          };

          const exitFromPause = () => {
            stateRef.current.isPlaying = false;
            setGameState('menu');
          };

          const restartFromPause = () => {
            // Restart current level
            const { currentLessonWords, title } = stateRef.current;
            
            // Recalculate goals logic (same as startGame)
            const totalWords = currentLessonWords.length;
            let goals = [];
            if (totalWords > 30) {
                const chunkSize = 15;
                for (let count = chunkSize; count < totalWords; count += chunkSize) {
                    goals.push(count);
                }
                goals.push(totalWords);
            } else {
                if (totalWords < 8) {
                    goals = [totalWords];
                } else if (totalWords < 15) {
                    goals = [Math.ceil(totalWords * 0.4), totalWords];
                } else {
                    goals = [Math.ceil(totalWords * 0.3), Math.ceil(totalWords * 0.65), totalWords];
                }
            }

            setScore(0);
            setLives(3); // ä¿®æ”¹ï¼šé‡ç½®ç”Ÿå‘½å€¼æ”¹ç‚º 3
            setCombo(0);
            setFallingWords([]);
            setTargetWordId(null);
            setOptions([]);
            setCurrentStageDisplay(0);
            setMasteredCountDisplay(0);
            setStageGoalDisplay(goals[0]);
            setBgWords([]); // Reset background words

            // ç¢ºä¿å¾ Pause é‡å•Ÿæ™‚ä¹Ÿä½¿ç”¨ç•¶å‰çš„é›£åº¦è¨­å®š (é›–ç„¶é€šå¸¸ä¸æœƒè®Šï¼Œä½†ä¿æŒä¸€è‡´)
            const currentSettings = stateRef.current.settings || DIFFICULTY_SETTINGS[currentDifficulty];

            stateRef.current = {
              fallingWords: [],
              isPlaying: false,
              lastTime: 0,
              spawnTimer: 0,
              score: 0,
              currentLessonWords: currentLessonWords,
              title: title,
              masteredWords: new Set(),
              wrongWordIds: new Set(),
              currentStage: 0,
              stageGoals: goals,
              combo: 0,
              settings: currentSettings
            };

            startCountdown();
          };

          // Confetti Loop - Modified to check isRewardOpened
          useEffect(() => {
            if (gameState !== 'victory' || !isRewardOpened) return;
            
            const canvas = document.getElementById('confetti-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const particles = [];
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];
            
            const createParticle = () => {
                return {
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 10 + 5,
                    speed: Math.random() * 5 + 2,
                    angle: Math.random() * 360,
                    spin: Math.random() < 0.5 ? -1 : 1
                };
            };

            // Fill initial particles
            for (let i = 0; i < 150; i++) {
                particles.push(createParticle());
            }

            const animate = () => {
                if (gameState !== 'victory') return;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                particles.forEach((p, i) => {
                    p.y += p.speed;
                    p.angle += p.spin;
                    
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.angle * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                    ctx.restore();

                    if (p.y > canvas.height) {
                        particles[i] = createParticle();
                        particles[i].y = -10;
                    }
                });
                
                requestAnimationFrame(animate);
            };

            animate();

          }, [gameState, isRewardOpened]);

          const nextStage = () => {
            const nextStageIdx = stateRef.current.currentStage + 1;
            stateRef.current.currentStage = nextStageIdx;
            stateRef.current.fallingWords = [];
            setCurrentStageDisplay(nextStageIdx);
            setStageGoalDisplay(stateRef.current.stageGoals[nextStageIdx]);
            setFallingWords([]);
            startCountdown();
          };

          const handleKeyDown = useCallback((e) => {
            if (gameState !== 'playing') return;
            if (e.key === '1' && options[0]) handleOptionClick(options[0]);
            if (e.key === '2' && options[1]) handleOptionClick(options[1]);
            if (e.key === '3' && options[2]) handleOptionClick(options[2]);
          }, [gameState, options, targetWordId]);

          useEffect(() => {
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
          }, [handleKeyDown]);

            // New function to handle opening the reward
          const handleOpenReward = () => {
            setIsRewardOpened(true);
            playSound('victory');
          };

          // ä¿®æ”¹ï¼šå¢åŠ  difficultyOverride åƒæ•¸ï¼Œå…è¨±ç›´æ¥æŒ‡å®šé›£åº¦é–‹å§‹éŠæˆ²
          const startGame = (type, idOrData, fromState = undefined, difficultyOverride = null) => {
            initAudio(); // å•Ÿå‹•éŸ³æ•ˆ
            if (requestRef.current) {
              cancelAnimationFrame(requestRef.current);
            }

            // Update prevGameState if fromState is provided (not retry)
            if (fromState) {
                setPrevGameState(fromState);
            }

            // è™•ç†é›£åº¦è¨­å®š
            const targetDifficulty = difficultyOverride || currentDifficulty;
            // å¦‚æœæœ‰æŒ‡å®šé›£åº¦ï¼ŒåŒæ­¥æ›´æ–° React ç‹€æ…‹ï¼Œé€™æ¨£å›åˆ°ä¸»é¸å–®æ™‚ä¹Ÿæœƒé¸ä¸­è©²é›£åº¦
            if (difficultyOverride) {
                setCurrentDifficulty(difficultyOverride);
            }

            let wordsPool = [];
            let lessonTitle = "";

            if (type === 'preset') {
              if (idOrData === 'all') {
                wordsPool = ALL_WORDS_FALLBACK;
                lessonTitle = "ç¶œåˆè¤‡ç¿’";
                setSelectedLessonId('all');
              } else {
                if (!DEFAULT_LESSON_DATA[idOrData]) {
                    console.error("Invalid lesson ID:", idOrData);
                    return;
                }
                wordsPool = DEFAULT_LESSON_DATA[idOrData].words;
                lessonTitle = DEFAULT_LESSON_DATA[idOrData].title.split('ï¼š')[1];
                setSelectedLessonId(idOrData);
              }
            } else if (type === 'custom') {
              if (!idOrData || idOrData.length === 0) {
                alert("è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹ç”Ÿè©");
                return;
              }
              wordsPool = idOrData;
              lessonTitle = "è‡ªè¨‚é¡Œåº«";
              setSelectedLessonId('custom');
            }

            const totalWords = wordsPool.length;
            let goals = [];
            
            // Logic for large datasets (e.g. ALL words review)
            if (totalWords > 30) {
                const chunkSize = 15; // Every 15 words is a stage
                for (let count = chunkSize; count < totalWords; count += chunkSize) {
                    goals.push(count);
                }
                goals.push(totalWords); // Add the final total
            } else {
                // Logic for single lessons
                if (totalWords < 8) {
                    goals = [totalWords];
                } else if (totalWords < 15) {
                    goals = [Math.ceil(totalWords * 0.4), totalWords];
                } else {
                    goals = [Math.ceil(totalWords * 0.3), Math.ceil(totalWords * 0.65), totalWords];
                }
            }

            setScore(0);
            setLives(3); // ä¿®æ”¹ï¼šé–‹å§‹éŠæˆ²æ™‚ç”Ÿå‘½å€¼æ”¹ç‚º 3
            setCombo(0);
            setFallingWords([]);
            setTargetWordId(null);
            setOptions([]);
            setCurrentStageDisplay(0);
            setMasteredCountDisplay(0);
            setStageGoalDisplay(goals[0]);
            setBgWords([]); // Reset background words

            stateRef.current = {
              fallingWords: [],
              isPlaying: false, 
              lastTime: 0,
              spawnTimer: 0,
              score: 0,
              currentLessonWords: wordsPool,
              title: lessonTitle,
              masteredWords: new Set(),
              wrongWordIds: new Set(),
              currentStage: 0,
              stageGoals: goals,
              combo: 0,
              // ä½¿ç”¨ç›®æ¨™é›£åº¦è¨­å®š
              settings: DIFFICULTY_SETTINGS[targetDifficulty] 
            };

            startCountdown();
          };

          const retryMistakes = () => {
            const wrongWords = stateRef.current.currentLessonWords.filter(w => stateRef.current.wrongWordIds.has(w.id));
            if (wrongWords.length === 0) return;
            
            // FIX: Update customData state so that "Play Again" can access it later if needed
            setCustomData(wrongWords);
            
            startGame('custom', wrongWords);
          };
          
          // Helper: å–å¾—ä¸‹ä¸€å€‹é›£åº¦ç­‰ç´šçš„ ID (ç”¨æ–¼å‹åˆ©ç•«é¢)
          const getNextDifficulty = () => {
              if (currentDifficulty === 'slow') return 'normal';
              if (currentDifficulty === 'normal') return 'fast';
              return null;
          };
          
          const handleCopyLink = (lessonId) => {
             const url = new URL(window.location.href);
             url.searchParams.set('lesson', lessonId);
             const text = url.toString();
             
             // Create temporary element
             const textArea = document.createElement("textarea");
             textArea.value = text;
             
             // Ensure it's not visible but part of DOM
             textArea.style.position = "fixed";
             textArea.style.left = "-9999px";
             textArea.style.top = "0";
             document.body.appendChild(textArea);
             
             textArea.focus();
             textArea.select();
             
             try {
                const successful = document.execCommand('copy');
                if(successful) {
                    setShowShareToast(true);
                    setTimeout(() => setShowShareToast(false), 2000);
                }
             } catch (err) {
                console.error('Copy failed', err);
             }
             
             document.body.removeChild(textArea);
          };

          useEffect(() => {
            return () => {
                if (requestRef.current) cancelAnimationFrame(requestRef.current);
            };
          }, []);

          return (
            <div ref={containerRef} id="game-container" className="h-[100dvh] w-full bg-sky-900 text-white font-sans overflow-hidden relative selection:bg-none flex flex-col">
              
              {/* Damage Flash Overlay */}
              {damageFlash && (
                  <div className="absolute inset-0 bg-red-500/30 z-[60] pointer-events-none animate-damage"></div>
              )}

              <div className="absolute inset-0 overflow-hidden pointer-events-none">
                <div className="absolute top-20 left-10 text-sky-800/50 text-9xl font-serif select-none">è¯</div>
                <div className="absolute bottom-40 right-10 text-sky-800/50 text-9xl font-serif select-none">èª</div>
                <div className="absolute top-32 right-32 w-20 h-8 bg-white/10 rounded-full blur-xl"></div>
                
                {/* Background Words Layer */}
                {bgWords.map(word => (
                    <div
                        key={word.id}
                        className="absolute font-serif font-bold text-sky-200/20 select-none animate-pop-in"
                        style={{
                            left: `${word.x}%`,
                            top: `${word.y}%`,
                            '--rot': `${word.rotation}deg`, // ä½¿ç”¨ CSS è®Šæ•¸å‚³éæ—‹è½‰è§’åº¦
                            fontSize: word.fontSize
                        }}
                    >
                        {word.text}
                    </div>
                ))}
              </div>
              
              {/* Toast Notification */}
              {showShareToast && (
                <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-black/80 text-white px-4 py-2 rounded-full shadow-lg z-[100] animate-fade-in-up">
                  å·²è¤‡è£½èª²ç¨‹é€£çµï¼
                </div>
              )}

              {gameState === 'victory' && isRewardOpened && (
                <canvas 
                    id="confetti-canvas"
                    width={window.innerWidth} 
                    height={window.innerHeight} 
                    className="absolute inset-0 z-[60] pointer-events-none"
                />
              )}

              {/* Pause Menu Overlay */}
              {gameState === 'paused' && (
                <div className="absolute inset-0 flex items-center justify-center z-50 bg-sky-900/60 backdrop-blur-md">
                  <div className="bg-white text-sky-900 p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center border-4 border-sky-200 animate-fade-in-up">
                    <h2 className="text-3xl font-bold mb-6 text-sky-800 flex items-center justify-center gap-2">
                      <Pause size={32} /> éŠæˆ²æš«åœ
                    </h2>
                    
                    <div className="flex flex-col gap-3">
                      <button 
                        onClick={togglePause}
                        className="w-full bg-green-500 hover:bg-green-600 text-white text-xl py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2"
                      >
                        <PlayCircle size={24} fill="currentColor" /> ç¹¼çºŒéŠæˆ²
                      </button>
                      
                      <button 
                        onClick={restartFromPause}
                        className="w-full bg-sky-500 hover:bg-sky-600 text-white text-lg py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2"
                      >
                        <RotateCcw size={20} /> é‡æ–°é–‹å§‹
                      </button>
                      
                      <button 
                        onClick={exitFromPause}
                        className="w-full bg-white hover:bg-gray-50 border-2 border-gray-200 text-gray-600 text-lg py-3 rounded-xl font-bold flex items-center justify-center gap-2"
                      >
                        {prevGameState === 'menu' ? <Home size={20} /> : <ArrowLeft size={20} />}
                        {prevGameState === 'menu' ? 'å›ä¸»é¸å–®' : 'è¿”å›ä¸Šä¸€é '}
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Menu Screen */}
              {gameState === 'menu' && (
                <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-sky-950/80 backdrop-blur-sm p-4">
                   <div className="bg-white text-sky-900 p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center border-4 border-sky-200">
                      <div className="w-20 h-20 bg-sky-500 rounded-full flex items-center justify-center mx-auto mb-6 text-white shadow-lg">
                          <Volume2 size={40} />
                      </div>
                      <h1 className="text-3xl font-bold mb-2 text-sky-800">ç”Ÿè©ç‰¹è¨“ç­</h1>
                      <p className="text-sky-600 mb-6 font-medium">å­¸è¯èªå‘å‰èµ° ç¬¬äºŒå†Š</p>
                      
                      <div className="mb-4 w-full px-4">
                        <label className="block text-sky-300 text-sm font-bold mb-1 text-left flex items-center gap-1">
                            <Icon size={14}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></Icon>
                            å­¸ç”Ÿå§“å
                        </label>
                        <input
                            type="text"
                            value={playerName}
                            onChange={(e) => setPlayerName(e.target.value)}
                            placeholder="è«‹è¼¸å…¥åå­—..."
                            className="w-full p-3 rounded-xl border-2 border-sky-200 text-sky-800 focus:outline-none focus:border-sky-500 transition-colors text-center font-bold placeholder:font-normal placeholder:text-gray-400"
                        />
                      </div>

                      {/* é›£åº¦é¸æ“‡å€å¡Š (ç§»è‡³é€™è£¡) */}
                      <div className="bg-sky-50/50 p-3 rounded-xl mb-4 w-full border border-sky-100">
                          <h3 className="text-sky-400 text-xs font-bold mb-2 flex items-center justify-center gap-1">
                              <Target size={14} />
                              é¸æ“‡æŒ‘æˆ°é€Ÿåº¦
                          </h3>
                          <div className="grid grid-cols-3 gap-2">
                              {Object.values(DIFFICULTY_SETTINGS).map((setting) => (
                                  <button
                                      key={setting.id}
                                      onClick={() => { setCurrentDifficulty(setting.id); initAudio(); }}
                                      className={`
                                          relative p-1.5 rounded-lg border transition-all flex flex-col items-center justify-center h-16
                                          ${currentDifficulty === setting.id 
                                              ? `${setting.bg} border-transparent text-white shadow-md scale-105 z-10` 
                                              : 'bg-white border-sky-200 text-sky-400 hover:bg-sky-50'
                                          }
                                      `}
                                  >
                                      <span className="text-sm font-bold leading-tight">{setting.label.split(' ')[0]}</span>
                                      <span className="text-[10px] font-bold whitespace-nowrap">{setting.label.split(' ')[1]}</span>
                                      
                                      {currentDifficulty === setting.id && (
                                          <div className="absolute -top-1.5 -right-1.5 bg-white text-sky-900 rounded-full p-0.5 shadow-sm border border-sky-100">
                                              <CheckCircle size={10} />
                                          </div>
                                      )}
                                  </button>
                              ))}
                          </div>
                      </div>

                      <button type="button" onClick={() => { setGameState('levelSelect'); initAudio(); }} className="w-full bg-sky-500 hover:bg-sky-600 text-white text-xl py-4 rounded-xl font-bold shadow-lg mb-3 flex items-center justify-center gap-2 transition-transform active:scale-95">
                          <Play fill="currentColor" /> é–‹å§‹é—–é—œ
                      </button>

                      <div className="mt-6 text-xs text-sky-300 font-medium">
                        Design by Sophia Wong
                      </div>
                   </div>
                </div>
              )}
              
              {/* Single Lesson Intro Screen (from URL share) */}
              {gameState === 'singleLessonIntro' && (
                <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-sky-950/80 backdrop-blur-sm p-4">
                   <div className="bg-white text-sky-900 p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center border-4 border-sky-200">
                      <div className="w-20 h-20 bg-sky-500 rounded-full flex items-center justify-center mx-auto mb-6 text-white shadow-lg">
                          <Target size={40} />
                      </div>
                      <h1 className="text-2xl font-bold mb-2 text-sky-800">å°ˆå±¬æŒ‘æˆ°</h1>
                      <p className="text-sky-600 mb-6 font-medium text-lg">
                        {DEFAULT_LESSON_DATA[selectedLessonId]?.title || "è‡ªè¨‚èª²ç¨‹"}
                      </p>

                      <div className="mb-4 w-full px-4">
                        <label className="block text-sky-600 text-sm font-bold mb-1 text-left flex items-center gap-1">
                            <Icon size={14}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></Icon>
                            å­¸ç”Ÿå§“å
                        </label>
                        <input
                            type="text"
                            value={playerName}
                            onChange={(e) => setPlayerName(e.target.value)}
                            placeholder="è«‹è¼¸å…¥åå­—..."
                            className="w-full p-3 rounded-xl border-2 border-sky-200 text-sky-800 focus:outline-none focus:border-sky-500 transition-colors text-center font-bold placeholder:font-normal placeholder:text-gray-400"
                        />
                      </div>

                      {/* æ–°å¢ï¼šé›£åº¦é¸æ“‡å€å¡Š (For Single Lesson) */}
                      <div className="bg-sky-50/50 p-3 rounded-xl mb-4 w-full border border-sky-100">
                          <h3 className="text-sky-400 text-xs font-bold mb-2 flex items-center justify-center gap-1">
                              <Target size={14} />
                              é¸æ“‡æŒ‘æˆ°é€Ÿåº¦
                          </h3>
                          <div className="grid grid-cols-3 gap-2">
                              {Object.values(DIFFICULTY_SETTINGS).map((setting) => (
                                  <button
                                      key={setting.id}
                                      onClick={() => { setCurrentDifficulty(setting.id); initAudio(); }}
                                      className={`
                                          relative p-1.5 rounded-lg border transition-all flex flex-col items-center justify-center h-16
                                          ${currentDifficulty === setting.id 
                                              ? `${setting.bg} border-transparent text-white shadow-md scale-105 z-10` 
                                              : 'bg-white border-sky-200 text-sky-400 hover:bg-sky-50'
                                          }
                                      `}
                                  >
                                      <span className="text-sm font-bold leading-tight">{setting.label.split(' ')[0]}</span>
                                      <span className="text-[10px] font-bold whitespace-nowrap">{setting.label.split(' ')[1]}</span>
                                      
                                      {currentDifficulty === setting.id && (
                                          <div className="absolute -top-1.5 -right-1.5 bg-white text-sky-900 rounded-full p-0.5 shadow-sm border border-sky-100">
                                              <CheckCircle size={10} />
                                          </div>
                                      )}
                                  </button>
                              ))}
                          </div>
                      </div>
                      
                      <button 
                        type="button" 
                        onClick={() => startGame('preset', selectedLessonId, 'menu')} 
                        className="w-full bg-sky-500 hover:bg-sky-600 text-white text-xl py-4 rounded-xl font-bold shadow-lg mb-3 flex items-center justify-center gap-2 transition-transform active:scale-95"
                      >
                          <Play fill="currentColor" /> é–‹å§‹ç·´ç¿’
                      </button>

                      <button 
                        type="button" 
                        onClick={() => setGameState('menu')} 
                        className="w-full bg-white hover:bg-gray-100 text-sky-600 border-2 border-sky-200 text-lg py-3 rounded-xl font-bold flex items-center justify-center gap-2"
                      >
                          <Home size={20} /> å›ä¸»é¸å–®
                      </button>
                   </div>
                </div>
              )}

              {/* Custom Editor Screen */}
              {gameState === 'customEditor' && (
                <div className="absolute inset-0 flex flex-col z-50 bg-sky-900 overflow-y-auto">
                  <div className="p-4 max-w-lg mx-auto w-full h-full flex flex-col">
                    <button onClick={() => setGameState('levelSelect')} className="flex items-center gap-1 text-sky-300 mb-4 hover:text-white shrink-0">
                      <ArrowLeft size={20} /> è¿”å›èª²ç¨‹é¸æ“‡
                    </button>
                    <h2 className="text-2xl font-bold text-white mb-2 text-center">è‡ªè¨‚ç”Ÿè©è¡¨</h2>
                    <div className="bg-sky-800/50 p-3 rounded-lg text-sm text-sky-200 mb-4 flex gap-2">
                      <Info size={24} className="shrink-0 text-sky-400" />
                      <p>è«‹ä¾åºè¼¸å…¥ï¼š<br/><b>ç”Ÿè©, æ‹¼éŸ³, æ³¨éŸ³</b> (ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¸€è¡Œä¸€å€‹)<br/>ä¾‹å¦‚ï¼šæ—©å®‰, zÇo Än, ã„—ã„ Ë‡ ã„¢</p>
                    </div>
                    
                    <textarea 
                      className="flex-1 w-full bg-slate-800 text-white p-4 rounded-xl border-2 border-slate-600 focus:border-indigo-400 focus:outline-none font-mono text-lg leading-relaxed mb-4 resize-none shadow-inner"
                      value={customInputText}
                      onChange={(e) => setCustomInputText(e.target.value)}
                      placeholder="æ—©å®‰, zÇo Än, ã„—ã„ Ë‡ ã„¢"
                    />

                    <button 
                      type="button"
                      onClick={() => {
                        const parsed = parseCustomInput(customInputText);
                        if (parsed.length > 0) {
                          setCustomData(parsed);
                          startGame('custom', parsed, 'customEditor');
                        } else {
                          alert("æ ¼å¼ä¼¼ä¹ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥æ‚¨çš„è¼¸å…¥ã€‚");
                        }
                      }}
                      className="w-full bg-green-500 hover:bg-green-600 text-white text-xl py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95 shrink-0"
                    >
                      <Play fill="currentColor" /> ä½¿ç”¨æ­¤å…§å®¹é–‹å§‹éŠæˆ²
                    </button>
                  </div>
                </div>
              )}

              {/* Level Select Screen */}
              {gameState === 'levelSelect' && (
                <div className="absolute inset-0 flex flex-col z-50 bg-sky-900 overflow-y-auto">
                  <div className="p-4 max-w-lg mx-auto w-full">
                    {/* ä¿®æ­£ï¼šå°‡è¿”å›æŒ‰éˆ•æ”¹æˆæ›´æ˜é¡¯çš„æ¨£å¼ */}
                    <button 
                        onClick={() => setGameState('menu')} 
                        className="w-full bg-white hover:bg-gray-100 text-sky-600 border-2 border-sky-200 text-lg py-3 rounded-xl font-bold flex items-center justify-center gap-2 mb-6 shadow-md"
                    >
                      <ArrowLeft size={20} /> è¿”å›ä¸»é¸å–® (æ›äºº/æ›é›£åº¦)
                    </button>
                    
                    <h2 className="text-2xl font-bold text-white mb-6 text-center">é¸æ“‡èª²ç¨‹</h2>
                    
                    <div className="grid grid-cols-2 gap-4 pb-4">
                      {Object.entries(DEFAULT_LESSON_DATA).map(([id, data]) => (
                        <div key={id} className="relative group">
                            <button 
                              type="button"
                              onClick={() => startGame('preset', id, 'levelSelect')}
                              className="w-full bg-white/10 hover:bg-white/20 border border-sky-500/30 p-4 rounded-xl text-left transition-all active:scale-95 flex flex-col gap-2 pr-12"
                            >
                              <span className="text-xs text-sky-400 uppercase tracking-wider">Lesson {id}</span>
                              <span className="text-lg font-bold text-white truncate">{data.title.split('ï¼š')[1]}</span>
                            </button>
                            <button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleCopyLink(id);
                                }}
                                className="absolute right-3 top-1/2 -translate-y-1/2 p-2 text-sky-400 hover:text-white hover:bg-white/10 rounded-full transition-colors"
                                title="è¤‡è£½èª²ç¨‹é€£çµ"
                            >
                                <Share2 size={20} />
                            </button>
                        </div>
                      ))}
                    </div>

                    <div className="flex flex-col gap-3 pb-8">
                        <div className="flex items-center gap-2 text-sky-400 text-sm font-bold my-2">
                            <div className="h-px bg-sky-600 flex-1"></div>
                            <span>ç‰¹æ®Šæ¨¡å¼</span>
                            <div className="h-px bg-sky-600 flex-1"></div>
                        </div>

                        <button type="button" onClick={() => setGameState('customEditor')} className="w-full bg-indigo-500 hover:bg-indigo-600 text-white text-lg py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                            <Edit3 size={20} /> è‡ªè¨‚é¡Œåº«
                        </button>

                        <button type="button" onClick={() => startGame('preset', 'all', 'levelSelect')} className="w-full bg-amber-500 hover:bg-amber-600 text-white text-lg py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                            <Grid size={20} /> ç¶œåˆè¤‡ç¿’
                        </button>
                    </div>

                  </div>
                </div>
              )}

              {/* Countdown Overlay */}
              {gameState === 'countdown' && (
                <div className="absolute inset-0 flex items-center justify-center z-50 bg-sky-900/80 backdrop-blur-sm">
                  <div className="text-9xl font-bold text-white animate-bounce">
                    {countdown}
                  </div>
                </div>
              )}

              {/* Playing / Paused HUD & Game Area */}
              {(gameState === 'playing' || gameState === 'paused') && (
                <>
                  <div className="absolute top-0 left-0 right-0 p-2 md:p-4 flex justify-between items-start z-10 max-w-3xl mx-auto w-full">
                    <div className="flex items-start gap-2 md:gap-4">
                      <button 
                        onClick={togglePause}
                        className="mt-2 p-2 bg-white/10 hover:bg-white/20 rounded-full text-white/90 hover:text-white transition-colors backdrop-blur-sm border border-white/10 shadow-sm"
                        title="æš«åœ"
                      >
                        {gameState === 'paused' ? <Play size={24} fill="currentColor"/> : <Pause size={24} fill="currentColor" />}
                      </button>
                      
                      <div className="flex flex-col">
                        {/* æ¨™é¡Œèˆ‡é—œå¡è³‡è¨Š */}
                        <div className="flex flex-col md:flex-row md:items-end gap-1 md:gap-3">
                            <h1 className="text-lg md:text-xl font-bold text-sky-100 truncate max-w-[140px] md:max-w-[250px] drop-shadow-sm">
                              {stateRef.current.title}
                            </h1>
                            <span className="text-xs bg-yellow-500/90 px-2 py-0.5 rounded text-white font-bold shadow-sm self-start md:self-auto md:mb-1">
                                é—œå¡ {currentStageDisplay + 1}/{stateRef.current.stageGoals.length}
                            </span>
                        </div>

                        {/* ä½¿ç”¨æ–°çš„åŠ‡æƒ…é€²åº¦æ¢ */}
                        <StoryProgressBar 
                            current={masteredCountDisplay} 
                            total={stageGoalDisplay} 
                            character={stateRef.current.settings?.character || 'ğŸ‡'}
                            startIcon={stateRef.current.settings?.startIcon || 'ğŸ'} 
                            endIcon={stateRef.current.settings?.endIcon || 'ğŸ¥•'} 
                        />
                      </div>
                    </div>

                    <div className="flex flex-col items-end gap-1 md:gap-2">
                        <div className="text-right bg-black/20 p-2 rounded-xl backdrop-blur-sm border border-white/5">
                            <p className="text-[10px] text-sky-300 font-bold tracking-wider">SCORE</p>
                            <p className="text-2xl md:text-3xl font-mono font-bold text-white leading-none">{score}</p>
                        </div>
                        {combo > 1 && (
                          <div className="text-yellow-400 font-bold text-lg md:text-xl animate-bounce drop-shadow-md">
                            ğŸ”¥ {combo} COMBO!
                          </div>
                        )}
                        <div className="flex gap-1 mt-1 bg-black/20 px-2 py-1 rounded-full backdrop-blur-sm">
                            {[...Array(3)].map((_, i) => ( 
                            <Heart 
                                key={i} 
                                size={20} 
                                className={`${i < lives ? 'fill-red-500 text-red-500 drop-shadow-sm' : 'text-sky-900/50'} transition-all`} 
                            />
                            ))}
                        </div>
                    </div>
                  </div>

                  <div className="relative w-full flex-1 max-w-xl mx-auto overflow-hidden z-0">
                    <div className={`absolute bottom-[28%] w-full border-t-2 border-dashed ${bottomWarn ? 'border-red-500 bg-red-500/20' : 'border-red-500/50'} pointer-events-none transition-colors duration-100 z-20`}>
                        <span className="absolute right-0 -top-6 text-xs text-red-400 font-bold px-2">è­¦æˆ’ç·š</span>
                    </div>

                    {fallingWords.map((word) => {
                        const isTarget = word.id === targetWordId;
                        return (
                            <div
                                key={word.id} 
                                className="absolute transform -translate-x-1/2 transition-none will-change-transform z-30" 
                                style={{ left: `${word.x}%`, top: `${word.y}%` }}
                            >
                                <div className={`
                                    relative flex flex-col items-center justify-center
                                    ${word.isBonus 
                                        ? 'bg-yellow-100 text-yellow-900 border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.6)]' 
                                        : 'bg-white text-sky-900 border-sky-200'}
                                    rounded-xl shadow-lg border-4 
                                    ${isTarget ? 'border-yellow-400 scale-110 shadow-[0_0_20px_rgba(250,204,21,0.6)]' : 'opacity-100'}
                                    px-4 py-3 min-w-[100px]
                                `}>
                                    {isTarget && (
                                        <div className="absolute -top-8 text-yellow-300 animate-bounce">
                                            <Target size={24} />
                                        </div>
                                    )}
                                    {word.isBonus && (
                                        <div className="absolute -top-3 -right-3 text-red-500 bg-white rounded-full p-0.5 shadow-sm border border-red-100">
                                            <Heart size={16} fill="currentColor" />
                                        </div>
                                    )}
                                    <span className="text-3xl md:text-4xl font-bold font-serif whitespace-nowrap">{word.chinese}</span>
                                </div>
                            </div>
                        );
                    })}

                    {hitEffect && (
                        <div 
                        className="absolute transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-40"
                        style={{ left: `${hitEffect.x}%`, top: `${hitEffect.y}%` }}
                        >
                            <div className="relative">
                                <div className="absolute inset-0 w-24 h-24 bg-yellow-300 rounded-full animate-ping opacity-80"></div>
                                <div className="absolute inset-0 w-24 h-24 bg-white rounded-full animate-ping delay-75 opacity-50"></div>
                            </div>
                        </div>
                    )}
                  </div>

                  <div className="absolute bottom-0 left-0 right-0 bg-sky-950/95 backdrop-blur-md border-t border-sky-800 p-4 z-40 h-[25%] min-h-[160px]">
                      <div className="max-w-xl mx-auto h-full flex flex-col justify-center">
                          <div className="flex justify-between items-center mb-2 px-1 shrink-0">
                              <span className="text-xs text-sky-400">è«‹é¸æ“‡æ­£ç¢ºè®€éŸ³ (1, 2, 3)</span>
                              {targetWordId && <span className="text-xs text-yellow-400 font-bold animate-pulse">é–å®šä¸­...</span>}
                          </div>
                          
                          <div className="grid grid-cols-3 gap-3 h-full pb-2">
                              {options.map((opt, idx) => (
                                  <button
                                      key={idx}
                                      onClick={() => handleOptionClick(opt)}
                                      className="bg-white/10 hover:bg-white/20 active:bg-sky-600 border border-sky-600/50 rounded-xl p-1 flex flex-col items-center justify-center transition-all h-full group relative overflow-hidden"
                                  >
                                      <span className="absolute top-1 left-2 text-sky-600/30 font-bold text-3xl -z-0 group-hover:scale-110 transition-transform">{idx + 1}</span>
                                      <span className="text-xl font-bold text-white z-10 mb-0.5">{opt.pinyin}</span>
                                      <span className="text-sm text-sky-200 z-10 font-mono text-center leading-tight">{opt.zhuin}</span>
                                  </button>
                              ))}
                              {options.length === 0 && (
                                  <div className="col-span-3 text-center flex items-center justify-center text-sky-500 italic h-full">
                                      ç­‰å¾…ç›®æ¨™å‡ºç¾...
                                  </div>
                              )}
                          </div>
                      </div>
                  </div>
                </>
              )}

              {/* Stage Clear Screen */}
              {gameState === 'stageClear' && (
                <div className="absolute inset-0 flex items-center justify-center z-50 bg-sky-950/90 backdrop-blur-sm p-4">
                   <div className="bg-white text-sky-900 p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center border-4 border-green-400 animate-fade-in-up">
                      <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <FastForward size={48} className="text-green-500" />
                      </div>
                      <h2 className="text-3xl font-bold mb-2 text-sky-800">é—œå¡ {currentStageDisplay + 1} å®Œæˆï¼</h2>
                      <p className="text-sky-600 mb-6">
                          å·²ç²¾ç†Ÿ {masteredCountDisplay} å€‹å–®å­—ã€‚<br/>
                          
                          {/* Motivational Messages based on stage */}
                          {(currentStageDisplay + 1) % 3 === 0 ? (
                            <span className="text-amber-600 font-bold mt-2 block text-lg animate-pulse">
                                {currentStageDisplay + 1 === 3 && "å¤ªæ£’äº†ï¼å·²ç¶“é€šéä¸‰é—œäº†ï¼"}
                                {currentStageDisplay + 1 === 6 && "ä¸å¯æ€è­°ï¼ä½ çš„å°ˆæ³¨åŠ›çœŸå¼·ï¼"}
                                {currentStageDisplay + 1 === 9 && "å …æŒä½ï¼å‹åˆ©å°±åœ¨çœ¼å‰ï¼"}
                                {currentStageDisplay + 1 > 9 && "ä½ æ˜¯è¯èªç‰¹è¨“å¤§å¸«ï¼"}
                            </span>
                          ) : (
                            <span className="text-slate-400 font-bold mt-2 block">
                                {(currentStageDisplay + 1) % 3 === 2 
                                    ? "ä¸‹ä¸€é—œé€Ÿåº¦å°‡æœƒç¨å¾®æå‡ï¼" 
                                    : "ä¿æŒç¯€å¥ï¼Œç¹¼çºŒå‰é€²ï¼"}
                            </span>
                          )}
                      </p>
                      
                      <button type="button" onClick={nextStage} className="w-full bg-green-500 hover:bg-green-600 text-white text-lg py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2">
                          <Play size={24} fill="currentColor" /> ç¹¼çºŒæŒ‘æˆ°
                      </button>
                   </div>
                </div>
              )}

              {/* Victory / Gameover Screen */}
              {(gameState === 'gameover' || gameState === 'victory') && (
                <div className="absolute inset-0 flex items-center justify-center z-50 bg-sky-950/90 backdrop-blur-sm p-4 overflow-y-auto">
                      <div className="bg-white text-sky-900 p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center border-4 border-sky-200 animate-fade-in-up my-auto">
                        {gameState === 'victory' && !isRewardOpened ? (
                            // ç¦®ç‰©ç›’ç‹€æ…‹
                           <>
                              <div 
                                onClick={handleOpenReward}
                                className="w-32 h-32 bg-red-100 rounded-2xl flex items-center justify-center mx-auto mb-6 cursor-pointer hover:scale-110 transition-transform animate-bounce shadow-lg border-4 border-red-200"
                              >
                                <Gift size={64} className="text-red-500" />
                              </div>
                              <h2 className="text-2xl font-bold mb-2 text-sky-800 animate-pulse">
                                {playerName ? `${playerName} ` : ""}æ­å–œé€šé—œï¼
                              </h2>
                              <p className="text-sky-600 mb-6 text-lg font-bold">é»æ“Šç¦®ç‰©ç›’é ˜å–çå‹µï¼</p>
                           </>
                        ) : (
                           // å·²æ‹†é–‹æˆ–æ˜¯å¤±æ•—ç‹€æ…‹
                           <>
                                {gameState === 'victory' ? (
                                   <>
                                      <div className="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                                        <Trophy size={40} className="text-yellow-500" />
                                      </div>
                                      <h2 className="text-2xl font-bold mb-1 text-sky-800">
                                        {playerName ? `${playerName} ` : ""}
                                        {stateRef.current.wrongWordIds.size === 0 ? "å®Œç¾é€šé—œï¼" : "æŒ‘æˆ°æˆåŠŸï¼"}
                                      </h2>
                                      
                                      <p className="text-lg text-sky-700 font-bold mb-2">
                                        {selectedLessonId && selectedLessonId !== 'all' && selectedLessonId !== 'custom' ? 
                                            `Lesson ${selectedLessonId}: ${stateRef.current.title}` : 
                                            stateRef.current.title}
                                      </p>
                                      
                                      <p className="text-sky-600 mb-4 text-sm">å¤ªæ£’äº†ï¼å­¸æœƒäº† {stateRef.current.currentLessonWords.length} å€‹ç”Ÿè©ã€‚</p>
                                   </>
                                ) : (
                                   <>
                                      <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <Heart size={40} className="text-gray-400" />
                                      </div>
                                      <h2 className="text-2xl font-bold mb-1 text-sky-800">å†æ¥å†å²</h2>
                                      <p className="text-sky-600 mb-4 text-sm">åŠ æ²¹ï¼Œå¤šç·´ç¿’å¹¾æ¬¡ï¼</p>
                                   </>
                                )}
                                
                                {stateRef.current.wrongWordIds.size > 0 ? (
                                  <div className="mb-4 bg-red-50 rounded-xl p-4 border border-red-100">
                                    <div className="flex items-center gap-2 mb-3 text-red-600 font-bold border-b border-red-200 pb-2">
                                      <AlertCircle size={18} />
                                      éŒ¯é¡Œå›é¡§ ({stateRef.current.wrongWordIds.size})
                                    </div>
                                    <div className="max-h-40 overflow-y-auto pr-1 space-y-2 text-left">
                                      {stateRef.current.currentLessonWords
                                        .filter(w => stateRef.current.wrongWordIds.has(w.id))
                                        .map(word => (
                                          <div key={word.id} 
                                               onClick={() => speak(word.chinese)}
                                               className="flex items-center justify-between bg-white p-2 rounded-lg shadow-sm cursor-pointer hover:bg-red-50 transition-colors"
                                          >
                                            <span className="font-bold text-lg text-slate-700">{word.chinese}</span>
                                            <div className="text-right">
                                              <div className="text-xs text-slate-500 font-mono">{word.pinyin}</div>
                                              <div className="text-xs text-slate-400 font-mono">{word.zhuin}</div>
                                            </div>
                                            <Volume2 size={14} className="text-slate-300 ml-2" />
                                          </div>
                                      ))
                                      }
                                    </div>
                                    <button 
                                      type="button"
                                      onClick={retryMistakes}
                                      className="w-full mt-3 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-bold shadow-sm flex items-center justify-center gap-2 text-sm"
                                    >
                                      <Zap size={16} fill="currentColor" /> åªç·´ç¿’éŒ¯é¡Œ
                                    </button>
                                  </div>
                                ) : (
                                  gameState === 'victory' && (
                                    <div className="mb-6 bg-green-50 rounded-xl p-4 border border-green-100 text-green-700">
                                      <p className="font-bold flex items-center justify-center gap-2">
                                        <Star className="fill-green-500 text-green-500" />
                                        å¤ªç¥äº†ï¼å®Œç¾ç„¡ç‘•ï¼
                                      </p>
                                    </div>
                                  )
                                )}

                                <div className="flex flex-col gap-2">
                                  
                                  {/* æ–°å¢ï¼šæŒ‘æˆ°ä¸‹ä¸€ç´šæŒ‰éˆ• (åƒ…åœ¨å‹åˆ©ä¸”æœ‰ä¸‹ä¸€ç´šæ™‚é¡¯ç¤º) */}
                                  {gameState === 'victory' && getNextDifficulty() && (
                                      <button 
                                        type="button"
                                        onClick={() => startGame(
                                            selectedLessonId === 'custom' ? 'custom' : 'preset', 
                                            selectedLessonId === 'custom' ? customData : selectedLessonId,
                                            undefined,
                                            getNextDifficulty() // å‚³å…¥ä¸‹ä¸€å€‹é›£åº¦
                                        )} 
                                        className="w-full bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-white text-lg py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 animate-pulse"
                                      >
                                        <span className="text-xl">ğŸ”¥</span> 
                                        æŒ‘æˆ°{DIFFICULTY_SETTINGS[getNextDifficulty()].label}
                                      </button>
                                  )}

                                  {/* æœ€é«˜é›£åº¦é€šé—œé¼“å‹µ */}
                                  {gameState === 'victory' && !getNextDifficulty() && (
                                      <div className="text-amber-400 font-bold text-sm mb-1 animate-bounce">
                                          ğŸ‘‘ ä½ å·²ç¶“æ˜¯æœ€é«˜ç­‰ç´šå¤§å¸«äº†ï¼
                                      </div>
                                  )}

                                  <button 
                                    type="button"
                                    onClick={() => startGame(selectedLessonId === 'custom' ? 'custom' : 'preset', selectedLessonId === 'custom' ? customData : selectedLessonId)} 
                                    className="w-full bg-sky-500 hover:bg-sky-600 text-white text-lg py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2"
                                  >
                                    <RotateCcw size={18} /> å†æ¬¡æŒ‘æˆ° (åŒé›£åº¦)
                                  </button>
                                  
                                  <div className="flex gap-2">
                                      <button type="button" onClick={() => setGameState(prevGameState)} className="flex-1 bg-white hover:bg-sky-50 border-2 border-sky-200 text-sky-700 text-lg py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                                        {prevGameState === 'menu' ? <Home size={18} /> : <ArrowLeft size={18} />}
                                        {prevGameState === 'menu' ? 'å›ä¸»é¸å–®' : 'è¿”å›ä¸Šä¸€é '}
                                      </button>
                                      
                                      {/* æ–°å¢ï¼šå¦‚æœä¸Šä¸€é ä¸æ˜¯ä¸»é¸å–® (ä¾‹å¦‚æ˜¯é¸èª²é )ï¼Œå¤šçµ¦ä¸€å€‹ç›´æ¥å›ä¸»é¸å–®çš„æŒ‰éˆ• */}
                                      {prevGameState !== 'menu' && (
                                          <button type="button" onClick={() => setGameState('menu')} className="bg-sky-800 hover:bg-sky-700 border-2 border-sky-600 text-sky-200 py-3 px-4 rounded-xl font-bold flex items-center justify-center" title="å›ä¸»é¸å–®">
                                            <Home size={18} />
                                          </button>
                                      )}
                                  </div>
                                </div>
                           </>
                        )}
                     </div>
                </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChineseFallingGame />);
    </script>
</body>
</html>